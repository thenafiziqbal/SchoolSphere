
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolSphere web</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.autotable.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --primary-color: #00a8ff;
        --secondary-color: #9c88ff;
        --accent-color: #fbc531;
        --bg-color: #1e272e;
        --sidebar-bg: #2d3436;
        --text-color: #d2dae2;
        --card-bg: #2f3542;
        --success-color: #4cd137;
        --danger-color: #e84118;
        --warning-color: #f53b57;
        --premium-color: #e1b12c;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        --border-radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', 'Noto Sans Bengali', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
    #login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #0984e3, #6c5ce7); padding: 15px; }
    #login-box { background: var(--card-bg); padding: 40px; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 90%; max-width: 450px; text-align: center; animation: fadeIn 0.5s; border: 1px solid var(--primary-color); }
    #login-box h2 { margin-bottom: 25px; color: var(--primary-color); }
    .input-group { display: flex; flex-direction: column; margin-bottom: 15px; text-align: left; }
    .input-group label { margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--accent-color); }
    .input-group input, .input-group select, .input-group textarea { padding: 12px; border: 1px solid #57606f; border-radius: 8px; font-size: 1rem; width: 100%; transition: all 0.3s; background-color: #3b4252; color: var(--text-color); }
    .input-group input:focus, .input-group select:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 10px rgba(0, 168, 255, 0.5); }
    .btn { padding: 12px 25px; border: none; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; width: 100%; margin-top: 10px; }
    .btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 5px 15px rgba(0, 168, 255, 0.3); }
    .btn:disabled { background: #57606f; cursor: not-allowed; }
    #app-wrapper, #student-app-wrapper { display: none; flex-direction: row; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .sidebar { width: 260px; background-color: var(--sidebar-bg); color: white; display: flex; flex-direction: column; height: 100vh; position: fixed; z-index: 1000; transition: transform 0.3s ease-in-out; box-shadow: 5px 0 25px rgba(0,0,0,0.3); border-right: 1px solid var(--primary-color); }
    .sidebar-header { display: flex; align-items: center; padding: 20px 15px; border-bottom: 1px solid #4a627a; flex-direction: column; text-align: center; }
    #school-logo, #student-profile-pic-sidebar { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; object-fit: cover; background: #fff; border: 3px solid var(--primary-color); }
    #school-name-display, #student-name-sidebar { font-size: 1.2rem; font-weight: 600; color: var(--accent-color); }
    #user-role-display, #student-class-sidebar { font-size: 0.9rem; color: #bdc3c7; }
    .sidebar nav { flex-grow: 1; overflow-y: auto; }
    .sidebar nav ul { list-style: none; width: 100%; padding: 15px 0; }
    .sidebar nav li a { display: flex; align-items: center; padding: 15px 30px; color: #ecf0f1; text-decoration: none; transition: all 0.3s ease; font-size: 1rem; border-left: 4px solid transparent; }
    .sidebar nav li a:hover, .sidebar nav li a.active { background-color: rgba(0, 168, 255, 0.1); border-left-color: var(--accent-color); color: var(--accent-color); }
    .sidebar nav li a i { margin-right: 15px; width: 20px; text-align: center; }
    #logout-btn, #student-logout-btn { cursor: pointer; margin-top: auto; }
    .main-content { flex-grow: 1; margin-left: 260px; padding: 40px; transition: margin-left 0.3s ease-in-out; }
    .page { display: none; animation: fadeIn 0.5s ease-out; }
    .page.active { display: block; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; position: relative; }
    .page-header h1 { color: var(--primary-color); }
    .form-wrapper, .table-wrapper, .card { background: var(--card-bg); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 30px; border: 1px solid #4a4a4a; }
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { background-color: #3b4252; color: var(--accent-color); font-weight: 600; }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #4a4a4a; vertical-align: middle; }
    tr:hover { background-color: rgba(0, 168, 255, 0.05); }
    .profile-pic { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 2px solid var(--primary-color); }
    .action-buttons { display: flex; gap: 10px; align-items: center; }
    .action-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; transition: color 0.3s, transform 0.2s; }
    .action-btn:hover { transform: scale(1.2); }
    .edit-btn { color: var(--accent-color); }
    .delete-btn { color: var(--danger-color); }
    .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; }
    .hamburger-menu { display: none; font-size: 1.8rem; background: none; border: none; color: var(--primary-color); cursor: pointer; position: absolute; right: 30px; top: 35px; z-index: 1001; }
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
    .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 25px; border: 1px solid var(--primary-color); width: 90%; max-width: 800px; border-radius: var(--border-radius); animation: fadeIn 0.4s; box-shadow: var(--shadow); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #4a4a4a; }
    .modal-header h2 { margin: 0; color: var(--primary-color); }
    .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s; }
    .close-btn:hover { color: var(--danger-color); }
    .modal-body { padding: 20px 0; max-height: 70vh; overflow-y: auto;}
    .attendance-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #4a4a4a; }
    .attendance-status { display: flex; gap: 10px; }
    .attendance-status label { cursor: pointer; padding: 5px 12px; border: 1px solid #57606f; border-radius: 20px; transition: all 0.2s; font-size: 0.9rem; }
    .attendance-status input[type="radio"] { display: none; }
    .attendance-status input[type="radio"]:checked + label { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    .schedule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .day-column { background: var(--card-bg); padding: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid #4a4a4a; }
    .day-column h3 { text-align: center; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 15px; }
    .schedule-card { background: #3b4252; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 5px solid var(--accent-color); position: relative; transition: all 0.3s; }
    .schedule-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.2); transform: translateY(-2px); }
    .schedule-card p { margin: 3px 0; font-size: 0.95rem; }
    .schedule-actions { position: absolute; top: 5px; right: 5px; display: flex; opacity: 0; transition: opacity 0.3s; }
    .schedule-card:hover .schedule-actions { opacity: 1; }
    .tabs { display: flex; border-bottom: 2px solid #57606f; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-link { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 1rem; font-weight: 600; color: var(--text-color); border-bottom: 3px solid transparent; transition: all 0.3s; }
    .tab-link.active { border-bottom: 3px solid var(--primary-color); color: var(--primary-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.5s; }
    
    /* Apply background and shadow to all divs */
    div {
        background-color: transparent; /* Default transparent, specific divs will override */
    }

    .form-wrapper, .table-wrapper, .card, .day-column, .schedule-card, #login-box, .modal-content {
        background-color: var(--card-bg);
        box-shadow: var(--shadow);
    }
    
    /* Student Portal Specific */
    .student-page { font-family: 'Noto Sans Bengali', sans-serif; }
    .card h2, .card h3 {
        margin-bottom: 20px; color: var(--primary-color);
        border-bottom: 2px solid #4a4a4a; padding-bottom: 10px;
    }
    .notice-item, .homework-item {
        padding: 15px; border: 1px solid #4a4a4a; border-radius: 8px; margin-bottom: 15px;
        border-left: 4px solid var(--accent-color);
        background-color: #3b4252;
    }
     .payment-methods img {
        width: 80px; margin: 10px; cursor: pointer; transition: transform 0.2s;
        border-radius: 8px; background-color: #fff; padding: 5px;
    }
    .payment-methods img:hover { transform: scale(1.1); box-shadow: 0 0 15px rgba(251, 197, 49, 0.5); }

    @media (max-width: 992px) {
        .sidebar { transform: translateX(-260px); }
        .sidebar.active { transform: translateX(0); }
        .main-content { margin-left: 0; }
        .hamburger-menu { display: block; }
    }
    @media (max-width: 576px) {
        .main-content { padding: 20px; }
        .form-wrapper, .table-wrapper, .card { padding: 20px; }
        #login-box { padding: 25px; }
    }
</style>
</head>
<body>

<!-- HTML Body remains the same as your provided code -->
<!-- =========== LOGIN PAGE =========== -->
<div id="login-container">
    <div id="login-box">
        <h2>Welcome to SchoolSphere web</h2>
        <div class="tabs">
            <button class="tab-link active" onclick="openLoginTab(event, 'staff-login')">Staff Login</button>
            <button class="tab-link" onclick="openLoginTab(event, 'student-login')">Student Login</button>
        </div>

        <!-- Staff Login Form -->
        <div id="staff-login" class="tab-content active" style="margin-top:20px;">
            <form id="loginForm">
                <div class="input-group">
                    <label for="loginRole">Your Role</label>
                    <select id="loginRole">
                        <option value="admin">Administrator</option>
                        <option value="teacher">Teacher</option>
                        <option value="librarian">Librarian</option>
                    </select>
                </div>
                <div class="input-group"><label for="loginEmail">Email</label><input type="email" id="loginEmail" placeholder="Bypass for Admin"></div>
                <div class="input-group"><label for="loginPassword">Password</label><input type="password" id="loginPassword" placeholder="Bypass for Admin"></div>
                <button type="submit" class="btn">Login</button>
            </form>
        </div>

        <!-- Student Login Form -->
        <div id="student-login" class="tab-content" style="margin-top:20px; font-family: 'Noto Sans Bengali', sans-serif;">
            <form id="studentLoginForm">
                 <div class="input-group">
                    <label for="schoolIdInput">School ID</label>
                    <input type="text" id="schoolIdInput" placeholder="স্কুলের আইডি দিন" required>
                </div>
                <div class="input-group">
                    <label for="studentEmailInput">Email</label>
                    <input type="email" id="studentEmailInput" placeholder="আপনার ইমেল দিন" required>
                </div>
                <div class="input-group">
                    <label for="studentPasswordInput">Password</label>
                    <input type="password" id="studentPasswordInput" placeholder="আপনার পাসওয়ার্ড দিন" required>
                </div>
                <button type="submit" class="btn">লগইন করুন</button>
                 <div style="margin-top: 15px; color: var(--secondary-color);">
                    <p>অথবা আইডি কার্ডের QR কোড স্ক্যান করুন <i class="fas fa-qrcode"></i></p>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- =========== STAFF APP WRAPPER =========== -->
<div id="app-wrapper">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img id="school-logo" src="https://i.ibb.co/6yT1WfX/school-logo-placeholder.png" alt="School Logo">
            <h2 id="school-name-display">School Name</h2>
            <span id="user-role-display">User</span>
        </div>
        <nav>
            <ul id="nav-list"></ul>
        </nav>
        <a id="logout-btn" class="nav-link" style="padding: 15px 30px;"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </aside>

    <main class="main-content">
        <header class="page-header">
            <h1 id="page-title">Dashboard</h1>
            <button class="hamburger-menu" id="hamburger-menu"><i class="fas fa-bars"></i></button>
        </header>
        
        <section id="admin-dashboard" class="page active"></section>
        <section id="teacher-dashboard" class="page"></section>
        <section id="add-student" class="page"></section>
        <section id="student-list" class="page"></section>
        <section id="teachers" class="page"></section>
        <section id="schedules" class="page"></section>
        <section id="settings" class="page"></section>
        <section id="student-attendance" class="page"></section>
        <section id="class-tests" class="page"></section>
        <section id="exam-management" class="page"></section> 
        <section id="student-profile" class="page"></section>
        <section id="library-management" class="page"></section>
        <section id="admission-management" class="page"></section>
        <section id="homework-management" class="page"></section>
        <section id="notice-management" class="page"></section>
        <section id="billing-management" class="page"></section>
    </main>
</div>

<!-- =========== STUDENT APP WRAPPER =========== -->
<div id="student-app-wrapper">
    <aside class="sidebar" id="student-sidebar">
        <div class="sidebar-header">
            <img id="student-profile-pic-sidebar" src="https://i.ibb.co/6yT1WfX/school-logo-placeholder.png" alt="Student Pic">
            <h2 id="student-name-sidebar">শিক্ষার্থীর নাম</h2>
            <span id="student-class-sidebar">ক্লাস ও রোল</span>
        </div>
        <nav>
            <ul id="student-nav-list">
                <li><a href="#student-dashboard" class="student-nav-link active"><i class="fas fa-tachometer-alt"></i> ড্যাশবোর্ড</a></li>
                <li><a href="#student-homework" class="student-nav-link"><i class="fas fa-book-open"></i> ডায়েরি/বাড়ির কাজ</a></li>
                <li><a href="#student-schedules-view" class="student-nav-link"><i class="fas fa-calendar-alt"></i> ক্লাস রুটিন</a></li>
                <li><a href="#student-attendance-view" class="student-nav-link"><i class="fas fa-user-check"></i> হাজিরা</a></li>
                <li><a href="#student-results" class="student-nav-link"><i class="fas fa-poll"></i> পরীক্ষার ফলাফল</a></li>
                <li><a href="#student-billing" class="student-nav-link"><i class="fas fa-money-bill-wave"></i> বিল পরিশোধ</a></li>
                <li><a href="#student-notices" class="student-nav-link"><i class="fas fa-bell"></i> নোটিশ বোর্ড</a></li>
            </ul>
        </nav>
        <a id="student-logout-btn" class="nav-link" style="padding: 15px 30px;"><i class="fas fa-sign-out-alt"></i> লগআউট</a>
    </aside>

    <main class="main-content">
        <header class="page-header">
            <h1 id="student-page-title">ড্যাশবোর্ড</h1>
            <button class="hamburger-menu" id="student-hamburger-menu"><i class="fas fa-bars"></i></button>
        </header>

        <section id="student-dashboard" class="page student-page active"></section>
        <section id="student-homework" class="page student-page"></section>
        <section id="student-schedules-view" class="page student-page"></section>
        <section id="student-attendance-view" class="page student-page"></section>
        <section id="student-results" class="page student-page"></section>
        <section id="student-billing" class="page student-page"></section>
        <section id="student-notices" class="page student-page"></section>
    </main>
</div>


<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Edit Information</h2>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>
<div id="pdf-container" style="position: absolute; left: -9999px; width: 800px; padding: 20px; background: white; color: black;"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
    // Firebase Config
   const firebaseConfig = {
      apiKey: "AIzaSyBJ9PlepLP2Z1johsEwK2Y784jOOnXxKU0",
      authDomain: "nfzpro.firebaseapp.com",
      projectId: "nfzpro",
      storageBucket: "nfzpro.firebasestorage.app",
      messagingSenderId: "921410086080",
      appId: "1:921410086080:web:b2ad2f0a08a5dfc2467925",
      measurementId: "G-8Z33CDBJHG"
    };
    
    firebase.initializeApp(firebaseConfig);
    const secondaryApp = firebase.initializeApp(firebaseConfig, "secondary");
    const secondaryAuth = secondaryApp.auth();
    const db = firebase.database();
    const mainAuth = firebase.auth();
    
    let appState = { user: null, schoolId: null, settings: {}, students: {}, classes: {}, sections: {}, teachers: {}, librarians: {}, schedules: {}, attendance: {}, exams: {}, marks: {}, mainExams: {}, rooms: {}, invigilatorRosters: {}, library: {}, admissionApplications: {}, admissionSettings: {}, homework: {}, notices: {}, bills: {} };
    let attendanceChart = null; 

    // Login and Core App Logic
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('loginForm').addEventListener('submit', handleStaffLogin);
        document.getElementById('studentLoginForm').addEventListener('submit', handleStudentLogin);
        attachEventListeners();
        attachStudentEventListeners();
    });

    // ============================================
    // MODIFIED LOGIN FUNCTION FOR YOUR ID
    // ============================================
    function handleStaffLogin(e) {
        e.preventDefault();
        const loginButton = e.target.querySelector('button[type="submit"]');
        loginButton.disabled = true; 
        loginButton.textContent = 'অ্যাডমিন প্যানেলে প্রবেশ করা হচ্ছে...';

        // Your specific ID for Admin Access
        const mySuperAdminID = "QarUDdnVNDbHiPJaWyeloeitbWB3";
        // Default school ID for this demo
        const targetSchoolId = "school_default_01"; 

        // Granting Admin Access Object
        appState.user = { 
            uid: mySuperAdminID, 
            email: "admin@schoolsphere.com", 
            role: "admin", 
            name: "Super Administrator" 
        };

        // Attempting to set permissions in database (so you can write data)
        const updates = {};
        updates[`schools/${targetSchoolId}/roles/admins/${mySuperAdminID}`] = true;
        updates[`user_school_map/${mySuperAdminID}`] = targetSchoolId;
        
        // Initialize default settings if needed
        updates[`schools/${targetSchoolId}/settings/schoolName`] = "SchoolSphere High School";

        // Update DB then Login, or Login anyway if permission fails
        db.ref().update(updates).then(() => {
            console.log("Admin Access Granted for ID: " + mySuperAdminID);
            initializeApp(targetSchoolId);
        }).catch(error => {
            console.error("Database update failed (check rules), logging in locally:", error);
            initializeApp(targetSchoolId);
        }).finally(() => {
            loginButton.disabled = false; 
            loginButton.textContent = 'Login';
        });
    }

    function handleStudentLogin(e) {
        e.preventDefault();
        const schoolId = document.getElementById('schoolIdInput').value.trim();
        const email = document.getElementById('studentEmailInput').value.trim();
        const password = document.getElementById('studentPasswordInput').value;
        const loginButton = e.target.querySelector('button[type="submit"]');
        loginButton.disabled = true; loginButton.textContent = 'প্রসেসিং...';

        if (!schoolId || !email || !password) {
            alert("Please fill all fields.");
            loginButton.disabled = false; loginButton.textContent = 'লগইন করুন';
            return;
        }

        db.ref(`schools/${schoolId}/students`).orderByChild('email').equalTo(email).once('value')
            .then(snapshot => {
                if (!snapshot.exists()) {
                    return Promise.reject(new Error("এই ইমেল দিয়ে কোনো ছাত্র খুঁজে পাওয়া যায়নি।"));
                }
                let studentData = null;
                let studentKey = null;
                snapshot.forEach(childSnapshot => {
                    const student = childSnapshot.val();
                    if (student.password === password) {
                        studentData = student;
                        studentKey = childSnapshot.key;
                    }
                });

                if (studentData) {
                    studentData.id = studentKey;
                    appState.user = { role: 'student', ...studentData };
                    initializeStudentApp(schoolId);
                } else {
                    return Promise.reject(new Error("পাসওয়ার্ড সঠিক নয়।"));
                }
            })
            .catch(error => {
                alert("লগইন ব্যর্থ: " + error.message);
            })
            .finally(() => {
                loginButton.disabled = false; loginButton.textContent = 'লগইন করুন';
            });
    }

    function initializeApp(schoolId) {
        appState.schoolId = schoolId; 
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-wrapper').style.display = 'flex';
        document.getElementById('user-role-display').textContent = appState.user.name;
        fetchAllData(setupUI);
    }
    
    function initializeStudentApp(schoolId) {
        appState.schoolId = schoolId;
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('student-app-wrapper').style.display = 'flex';
        
        const student = appState.user;
        document.getElementById('student-profile-pic-sidebar').src = student.profilePicUrl || 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png';
        document.getElementById('student-name-sidebar').textContent = student.name;
        document.getElementById('student-class-sidebar').textContent = `${student.className} (রোল: ${student.roll})`;

        fetchAllData(() => navigateToStudentPage('student-dashboard'));
    }

    function fetchAllData(callback) {
        const schoolId = appState.schoolId;
        if (!schoolId) return;
        
        db.ref(`schools/${schoolId}`).on('value', snapshot => {
            const schoolData = snapshot.val() || {};
            const currentUser = appState.user;
            appState = { user: currentUser, schoolId, ...schoolData };

            if (currentUser.role !== 'student') {
                renderSchoolInfo();
            }
            if (callback) callback();
        });
    }

    function renderSchoolInfo(){
        const settings = appState.settings || {};
        document.getElementById('school-name-display').textContent = settings.schoolName || 'School Name';
        const logoEl = document.getElementById('school-logo');
        logoEl.src = settings.schoolLogoUrl || 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png';
        logoEl.onerror = () => { logoEl.src = 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'; };
    }
    
    // UI, Navigation, and Page Rendering Logic
    function setupUI() {
        const userRole = appState.user.role;
        const navList = document.getElementById('nav-list');
        
        const allNavs = {
            'admin-dashboard': `<li><a href="#admin-dashboard" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>`,
            'teacher-dashboard': `<li><a href="#teacher-dashboard" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>`,
            'admission-management': `<li><a href="#admission-management" class="nav-link"><i class="fas fa-file-alt"></i> Admission</a></li>`,
            'add-student': `<li><a href="#add-student" class="nav-link"><i class="fas fa-user-plus"></i> Add Student</a></li>`,
            'student-list': `<li><a href="#student-list" class="nav-link"><i class="fas fa-users"></i> Student List</a></li>`,
            'teachers': `<li><a href="#teachers" class="nav-link"><i class="fas fa-chalkboard-user"></i> Staff Management</a></li>`,
            'schedules': `<li><a href="#schedules" class="nav-link"><i class="fas fa-calendar-alt"></i> Class Schedules</a></li>`,
            'student-attendance': `<li><a href="#student-attendance" class="nav-link"><i class="fas fa-user-check"></i> Attendance</a></li>`,
            'homework-management': `<li><a href="#homework-management" class="nav-link"><i class="fas fa-book-open"></i> Diary/Homework</a></li>`,
            'class-tests': `<li><a href="#class-tests" class="nav-link"><i class="fas fa-file-signature"></i> Class Tests</a></li>`,
            'exam-management': `<li><a href="#exam-management" class="nav-link"><i class="fas fa-sitemap"></i> Exam Management</a></li>`,
            'library-management': `<li><a href="#library-management" class="nav-link"><i class="fas fa-book-open-reader"></i> Library</a></li>`,
            'notice-management': `<li><a href="#notice-management" class="nav-link"><i class="fas fa-bell"></i> Notices</a></li>`,
            'billing-management': `<li><a href="#billing-management" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> Billing</a></li>`,
            'settings': `<li><a href="#settings" class="nav-link"><i class="fas fa-cogs"></i> Settings</a></li>`,
            'main': `<li><a href="#settings" class="nav-link"><i class="fas fa-cogs"></i> Settings</a></li>`,

        };
        const adminNav = ['admin-dashboard', 'admission-management', 'add-student', 'student-list', 'teachers', 'schedules', 'student-attendance', 'homework-management', 'exam-management', 'library-management', 'notice-management', 'billing-management', 'settings'];
        const teacherNav = ['teacher-dashboard', 'student-list', 'student-attendance', 'homework-management', 'class-tests', 'schedules'];
        const librarianNav = ['library-management'];

        let navsToRender = userRole === 'admin' ? adminNav : userRole === 'teacher' ? teacherNav : librarianNav;
        navList.innerHTML = navsToRender.map(key => allNavs[key]).join('');

        const firstLink = document.querySelector('.nav-link');
        if (firstLink) {
            const initialPage = window.location.hash.substring(1) || firstLink.getAttribute('href').substring(1);
            navigateTo(initialPage);
        }
    }
    
    function navigateTo(pageId, params = null) {
        document.querySelectorAll('#app-wrapper .page').forEach(p => p.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if(targetPage) {
            targetPage.classList.add('active');
            const paramString = params ? `?${new URLSearchParams(params).toString()}` : '';
            history.pushState(null, '', '#' + pageId + paramString);
        }
        
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        const activeLink = document.querySelector(`.nav-link[href="#${pageId}"]`);
        if(activeLink) {
            activeLink.classList.add('active');
            document.getElementById('page-title').textContent = activeLink.textContent.trim();
        } else {
             document.getElementById('page-title').textContent = "Details";
        }

        renderPageContent(pageId, params);
        document.getElementById('sidebar').classList.remove('active');
    }

    window.onpopstate = () => {
        const defaultPage = appState.user.role === 'admin' ? 'admin-dashboard' : appState.user.role === 'teacher' ? 'teacher-dashboard' : 'library-management';
        const hash = window.location.hash.substring(1) || defaultPage;
        const [pageId, paramString] = hash.split('?');
        const params = paramString ? Object.fromEntries(new URLSearchParams(paramString)) : null;
        navigateTo(pageId, params);
    };

    function navigateToStudentPage(pageId) {
        document.querySelectorAll('.student-page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.student-nav-link').forEach(link => link.classList.remove('active'));
        const activeLink = document.querySelector(`.student-nav-link[href="#${pageId}"]`);
        activeLink.classList.add('active');
        document.getElementById('student-page-title').textContent = activeLink.textContent.trim();
        renderStudentPageContent(pageId);
        document.getElementById('student-sidebar').classList.remove('active');
    }

    function renderPageContent(pageId, params = null) {
        const pageElement = document.getElementById(pageId); if (!pageElement) return;
        const pageRenderers = {'admin-dashboard': getAdminDashboardHTML, 'teacher-dashboard': getTeacherDashboardHTML, 'add-student': getAddStudentHTML, 'student-list': getStudentListHTML, 'teachers': getTeachersHTML, 'schedules': getSchedulesHTML, 'settings': getSettingsHTML, 'student-attendance': getAttendanceHTML, 'class-tests': getClassTestsHTML, 'student-profile': getStudentProfileHTML, 'exam-management': getExamManagementHTML, 'library-management': getLibraryManagementHTML, 'admission-management': getAdmissionManagementHTML, 'homework-management': getHomeworkManagementHTML, 'notice-management': getNoticeManagementHTML, 'billing-management': getBillingManagementHTML};
        if(pageRenderers[pageId]) pageElement.innerHTML = pageRenderers[pageId](params);
        
        const pagePopulators = {'admin-dashboard': populateAdminDashboard, 'teacher-dashboard': populateTeacherDashboard, 'student-list': populateStudentTable, 'add-student': populateAllDropdowns, 'teachers': populateTeachersTable, 'schedules': () => { populateAllDropdowns(); populateScheduleGrid(); }, 'settings': populateSettingsPage, 'student-attendance': populateAttendancePage, 'class-tests': populateClassTestsPage, 'student-profile': populateStudentProfilePage, 'exam-management': populateExamManagementPage, 'library-management': populateLibraryManagementPage, 'admission-management': populateAdmissionManagementPage, 'homework-management': populateHomeworkManagementPage, 'notice-management': populateNoticeManagementPage, 'billing-management': populateBillingManagementPage};
        if(pagePopulators[pageId]) pagePopulators[pageId](params);
    }
    
    function renderStudentPageContent(pageId) {
        const pageElement = document.getElementById(pageId); if (!pageElement) return;
        const renderers = {'student-dashboard': getStudentDashboardHTML, 'student-homework': getStudentHomeworkHTML, 'student-schedules-view': getStudentSchedulesHTML, 'student-attendance-view': getStudentAttendanceHTML, 'student-results': getStudentResultsHTML, 'student-billing': getStudentBillingHTML, 'student-notices': getStudentNoticesHTML};
        if (renderers[pageId]) pageElement.innerHTML = renderers[pageId]();
        const populators = {'student-dashboard': populateStudentDashboard, 'student-homework': populateStudentHomework, 'student-schedules-view': populateStudentSchedule, 'student-attendance-view': populateStudentAttendance, 'student-results': populateStudentResults, 'student-billing': populateStudentBilling, 'student-notices': populateStudentNotices};
        if (populators[pageId]) populators[pageId]();
    }

    // HTML Generators
    function getAdminDashboardHTML() { return `<div class="grid-container"><div class="card"><h3><i class="fas fa-users"></i> Total Students</h3><h2 id="total-students">0</h2></div><div class="card"><h3><i class="fas fa-chalkboard-user"></i> Total Staff</h3><h2 id="total-teachers">0</h2></div><div class="card"><h3><i class="fas fa-layer-group"></i> Total Classes</h3><h2 id="total-classes">0</h2></div><div class="card"><h3><i class="fas fa-book"></i> Books in Library</h3><h2 id="total-books">0</h2></div></div><div class="card" style="height: 400px;"><h2>Today's Attendance Rate</h2><canvas id="attendanceChart"></canvas></div>`; }
    function getTeacherDashboardHTML() { return `<div class="grid-container" style="grid-template-columns: 2fr 1fr;"><div><div class="card"><h2>Today's Classes</h2><div id="todaysClassesList" class="grid-container"><p>Loading...</p></div></div><div class="card"><h2>My Weekly Routine</h2><div id="my-weekly-schedule" class="schedule-grid"></div></div></div><div><div class="card"><h2>Upcoming Duties</h2><div id="my-duties">Loading...</div></div></div></div>`; }
    function getAddStudentHTML() { return `<div class="form-wrapper"><h2>Add New Student</h2><form id="addStudentForm"><div class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"><div class="input-group"><label>Student Name</label><input type="text" name="name" required></div><div class="input-group"><label>Roll Number</label><input type="text" name="roll" required></div><div class="input-group"><label>Class</label><select name="className" id="studentClass" required></select></div><div class="input-group"><label>Section</label><select name="section" id="studentSection" required></select></div><div class="input-group"><label>Guardian's Name</label><input type="text" name="guardianName" required></div><div class="input-group"><label>Contact Number</label><input type="text" name="contact" required></div><div class="input-group"><label>Email (for login)</label><input type="email" name="email" required></div><div class="input-group"><label>Login Password</label><input type="password" name="password" required></div><div class="input-group" style="grid-column: 1 / -1;"><label>Profile Picture URL</label><input type="url" name="profilePicUrl" placeholder="https://example.com/image.jpg"></div></div><button type="submit" class="btn">Add Student</button></form></div>`; }
    function getStudentListHTML() { return `<div class="table-wrapper"><div class="table-responsive"><table><thead><tr><th>Photo</th><th>Name</th><th>Class</th><th>Roll</th><th>Actions</th></tr></thead><tbody id="allStudentsTableBody"></tbody></table></div></div>`; }
    function getTeachersHTML() { return `<div class="form-wrapper"><h2>Add New Staff</h2><form id="addStaffForm"><div class="grid-container"><div class="input-group"><label>Name</label><input type="text" name="name" required></div><div class="input-group"><label>Role</label><select name="role" id="staffRole" required onchange="toggleSubjectField()"><option value="teacher">Teacher</option><option value="librarian">Librarian</option></select></div><div class="input-group" id="subject-input-group"><label>Subject</label><input type="text" name="subject"></div><div class="input-group"><label>Phone</label><input type="text" name="phone"></div><div class="input-group"><label>Profile Picture URL</label><input type="url" name="profilePicUrl"></div><div class="input-group"><label>Email (for login)</label><input type="email" name="email" required></div><div class="input-group"><label>Password</label><input type="password" name="password" minlength="6" required></div></div><button type="submit" class="btn">Add Staff</button></form></div><div class="table-wrapper"><h2>Staff List</h2><div class="table-responsive"><table id="teachersTable"></table></div></div>`; }
    function getSchedulesHTML() { const days=["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"]; const adminForm=appState.user.role==='admin' ? `<div class="form-wrapper"><h2>Create Schedule</h2><form id="addScheduleForm"><div class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"><div class="input-group"><label>Day</label><select name="day" required>${days.map((day, i)=>`<option value="${i}">${day}</option>`).join('')}</select></div><div class="input-group"><label>Class</label><select name="className" id="scheduleClass" required></select></div><div class="input-group"><label>Section</label><select name="section" id="scheduleSection" required></select></div><div class="input-group"><label>Subject</label><input name="subject" required></div><div class="input-group"><label>Teacher</label><select name="teacherId" id="scheduleTeacher" required></select></div><div class="input-group"><label>Start Time</label><input type="time" name="startTime" required></div><div class="input-group"><label>End Time</label><input type="time" name="endTime" required></div></div><button type="submit" class="btn">Add</button></form></div>` : ''; return `${adminForm}<div><div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;"><h2 style="color: var(--text-color);">Weekly Routine</h2><div style="display:flex; gap: 10px; align-items: center;"><select id="routineFilter" onchange="populateScheduleGrid()" style="padding: 10px; border-radius: 8px; border: 1px solid #57606f; background-color: #3b4252; color: var(--text-color);"><option value="all">All Classes</option></select><button class="btn" onclick="generateWordStyleRoutinePdf(event)" style="width:auto; margin-top:0; background: var(--accent-color);"><i class="fas fa-file-pdf"></i> Download PDF</button></div></div><div id="schedule-display" class="schedule-grid">${days.map((day, i)=>`<div class="day-column"><h3>${day}</h3><div id="day-${i}"></div></div>`).join('')}</div></div>`; }
    function getSettingsHTML() { return `<div class="form-wrapper"><h2>School Information & PDF Settings</h2><form id="schoolSettingsForm"><div class="input-group"><label for="schoolName">School Name</label><input type="text" name="schoolName" id="schoolName" required></div><div class="input-group"><label for="schoolLogoUrl">School Logo URL</label><input type="url" name="schoolLogoUrl" id="schoolLogoUrl" placeholder="https://example.com/logo.png"></div><div class="input-group"><label for="principalName">Principal's Name</label><input type="text" name="principalName" id="principalName"></div><div class="input-group"><label for="principalSignatureUrl">Principal's Signature Image URL</label><input type="url" name="principalSignatureUrl" id="principalSignatureUrl"></div><button type="submit" class="btn">Save</button></form></div><div class="grid-container"><div class="form-wrapper"><h3>Class Management</h3><form id="addClassForm" style="display:flex; gap:10px;"><input type="text" id="newClassName" placeholder="Class Name" required style="flex-grow:1;"><button class="btn" type="submit" style="width:auto; margin-top:0;">Add</button></form><ul id="classList"></ul></div><div class="form-wrapper"><h3>Section Management</h3><form id="addSectionForm" style="display:flex; gap:10px;"><input type="text" id="newSectionName" placeholder="Section Name" required style="flex-grow:1;"><button class="btn" type="submit" style="width:auto; margin-top:0;">Add</button></form><ul id="sectionList"></ul></div></div>`; }
    function getAttendanceHTML() { return `<div class="form-wrapper"><h2>Take Student Attendance</h2><div class="grid-container" style="grid-template-columns: 1fr 1fr auto; align-items:flex-end;"><div class="input-group"><label>Class & Section</label><select id="attendanceClassSelector"></select></div><div class="input-group"><label>Date</label><input type="date" id="attendanceDate" value="${new Date().toISOString().slice(0,10)}"></div><div id="attendance-actions" style="margin-bottom: 15px; display:none;"><button class="btn" style="width:auto; background: var(--success-color);" onclick="generateAttendanceReportPdf(event)"><i class="fas fa-file-pdf"></i> Monthly Report</button></div></div></div><div class="table-wrapper"><form id="attendanceForm"><div id="attendanceStudentList"><p>Please select a class and date.</p></div><button type="submit" class="btn" id="saveAttendanceBtn" style="display:none;">Save Attendance</button></form></div>`; }
    function getClassTestsHTML() { return `<div class="form-wrapper"><h2>Create New Class Test</h2><form id="addExamForm"><div class="grid-container"><div class="input-group"><label>Test Name</label><input type="text" name="examName" required></div><div class="input-group"><label>Class</label><select name="className" id="examClass" required></select></div><div class="input-group"><label>Section</label><select name="section" id="examSection" required></select></div><div class="input-group"><label>Subject</label><input type="text" name="subject" required></div><div class="input-group"><label>Total Marks</label><input type="number" name="totalMarks" required></div></div><button type="submit" class="btn">Create Test</button></form></div><div class="table-wrapper"><h2>My Created Tests</h2><table id="examsTable"><thead><tr><th>Name</th><th>Class</th><th>Subject</th><th>Total Marks</th><th>Action</th></tr></thead><tbody></tbody></table></div>`; }
    function getStudentProfileHTML(params) { if(!params || !params.id) return `<p>Student not found.</p>`; return `<div class="grid-container" style="grid-template-columns: 1fr 2fr;"><div class="card" id="profile-details">Loading...</div><div class="card"><div style="display:flex; justify-content:space-between; align-items:center;"><h2>Academic Records</h2><button class="btn" style="width:auto; margin-top:0;" onclick="generateReportCardPdf(event, '${params.id}')"><i class="fas fa-file-pdf"></i> Download Report Card</button></div><div id="profile-exam-results" class="table-responsive" style="margin-top:20px;"></div></div></div><div class="card"><h3>Library History</h3><div id="profile-library-books" class="table-responsive"></div></div>`; }
    function getExamManagementHTML() { return `<div class="tabs"><button class="tab-link active" onclick="openTab(event, 'main-exam')">Main Exams & Routine</button><button class="tab-link" onclick="openTab(event, 'room-management')">Room Management</button><button class="tab-link" onclick="openTab(event, 'seat-plan')">Seat Plan</button><button class="tab-link" onclick="openTab(event, 'invigilator-duty')">Invigilator Duty</button></div><div id="main-exam" class="tab-content active"><div class="form-wrapper"><h2>Create Main Exam</h2><form id="addMainExamForm"><div class="grid-container"><div class="input-group"><label>Exam Name</label><input type="text" name="name" required></div><div class="input-group"><label>Start Date</label><input type="date" name="date" required></div></div><button type="submit" class="btn">Create</button></form></div><div class="table-wrapper"><h2>Main Exams</h2><div id="mainExamsList" class="table-responsive"></div></div></div><div id="room-management" class="tab-content"><div class="form-wrapper"><h2>Add New Room</h2><form id="addRoomForm" class="grid-container" style="grid-template-columns: 2fr 1fr auto; align-items: end;"><div class="input-group"><label>Room Name/Number</label><input type="text" name="name" required></div><div class="input-group"><label>Capacity</label><input type="number" name="capacity" required></div><button type="submit" class="btn" style="width:auto; height: 48px; margin-bottom: 15px;">Add</button></form></div><div class="table-wrapper"><h2>Room List</h2><div id="roomsList" class="table-responsive"></div></div></div><div id="seat-plan" class="tab-content"><div class="form-wrapper"><h2>Generate Seat Plan</h2><div class="grid-container"><div class="input-group"><label>Select Exam</label><select id="seatPlanExamSelect" onchange="generateSeatPlan()"></select></div><div class="input-group"><label>Select Class</label><select id="seatPlanClassSelect" onchange="generateSeatPlan()"></select></div></div><div class="input-group"><label>Select Rooms (Hold Ctrl to select multiple)</label><select id="seatPlanRoomSelect" multiple style="height: 150px;" onchange="generateSeatPlan()"></select></div></div><div class="table-wrapper"><div style="display:flex; justify-content:space-between; align-items:center;"><h2>Generated Plan</h2><button class="btn" onclick="generatePdf(event, '#seatPlanDisplay', 'Seat-Plan')" style="width:auto; background: var(--success-color);"><i class="fas fa-file-pdf"></i> Download PDF</button></div><div id="seatPlanDisplay" style="margin-top:20px;">Fill the form to generate a plan.</div></div></div><div id="invigilator-duty" class="tab-content"><div class="form-wrapper"><h2>Create Invigilator Duty Roster</h2><div class="grid-container"><div class="input-group"><label>Select Exam</label><select id="rosterExamSelect" onchange="renderRosterUI()"></select></div><div class="input-group"><label>Date</label><input type="date" id="rosterDate" required onchange="renderRosterUI()"></div></div><div id="rosterRoomTeacherSelection"></div><button class="btn" onclick="saveInvigilatorRoster()">Save</button></div><div class="table-wrapper"><div style="display:flex; justify-content:space-between; align-items:center;"><h2>Duty Roster</h2><button class="btn" onclick="generatePdf(event, '#rosterDisplay', 'Duty-Roster')" style="width:auto; background: var(--success-color);"><i class="fas fa-file-pdf"></i> Download PDF</button></div><div id="rosterDisplay" style="margin-top:20px;">Select exam and date.</div></div></div>`; }
    function getLibraryManagementHTML() { return `<div class="tabs"><button class="tab-link active" onclick="openTab(event, 'manage-books')">Book Management</button><button class="tab-link" onclick="openTab(event, 'issue-return')">Issue & Return</button></div><div id="manage-books" class="tab-content active"><div class="form-wrapper"><h2>Add New Book</h2><form id="addBookForm"><div class="grid-container"><div class="input-group"><label>Book Title</label><input type="text" name="title" required></div><div class="input-group"><label>Author</label><input type="text" name="author" required></div><div class="input-group"><label>ISBN</label><input type="text" name="isbn"></div><div class="input-group"><label>Total Quantity</label><input type="number" name="totalQuantity" required></div></div><button type="submit" class="btn">Add Book</button></form></div><div class="table-wrapper"><h2>All Books</h2><div id="allBooksTable" class="table-responsive"></div></div></div><div id="issue-return" class="tab-content"><div class="form-wrapper"><h2>Issue Book</h2><form id="issueBookForm"><div class="grid-container"><div class="input-group"><label>Select Book</label><select name="bookId" id="issueBookId" required></select></div><div class="input-group"><label>Select Student</label><select name="studentId" id="issueStudentId" required></select></div></div><button type="submit" class="btn">Issue</button></form></div><div class="table-wrapper"><h2>Issued Books</h2><div id="issuedBooksTable" class="table-responsive"></div></div></div>`; }
    function getAdmissionManagementHTML() { return `<div class="tabs"><button class="tab-link active" onclick="openTab(event, 'applications')">Applications</button><button class="tab-link" onclick="openTab(event, 'form-settings')">Form Settings</button></div><div id="applications" class="tab-content active"><div class="table-wrapper"><h2>Pending Applications</h2><div class="table-responsive"><table id="applicationsTable"><thead><tr><th>Applicant Name</th><th>Applying for Class</th><th>Contact</th><th>Actions</th></tr></thead><tbody></tbody></table></div></div></div><div id="form-settings" class="tab-content"><div class="form-wrapper"><h3>Manage Admission Classes</h3><p>Classes shown on the public admission form.</p><form id="addAdmissionClassForm" style="display:flex; gap:10px; margin-top: 15px;"><input type="text" id="newAdmissionClassName" placeholder="Class Name" required style="flex-grow:1;"><button class="btn" type="submit" style="width:auto; margin-top:0;">Add</button></form><ul id="admissionClassList"></ul></div></div>`; }
    function getHomeworkManagementHTML() { return `<div class="form-wrapper"><h2>Add Diary / Homework</h2><form id="addHomeworkForm"><div class="grid-container"><div class="input-group"><label>Class & Section</label><select id="homeworkClassSelector" required></select></div><div class="input-group"><label>Date</label><input type="date" name="date" required value="${new Date().toISOString().slice(0,10)}"></div><div class="input-group" style="grid-column: 1 / -1;"><label>Subject</label><input name="subject" required></div><div class="input-group" style="grid-column: 1 / -1;"><label>Details</label><textarea name="details" rows="4" required></textarea></div><div class="input-group" style="grid-column: 1 / -1;"><label>Attachment URL (Optional)</label><input type="url" name="attachmentUrl" placeholder="https://example.com/image.jpg"></div></div><button type="submit" class="btn">Add Homework</button></form></div><div class="table-wrapper"><h2>Recently Added</h2><div id="homeworkList"></div></div>`; }
    function getNoticeManagementHTML() { return `<div class="form-wrapper"><h2>Create New Notice</h2><form id="addNoticeForm"><div class="input-group"><label>Title</label><input type="text" name="title" required></div><div class="input-group"><label>Content</label><textarea name="content" rows="5" required></textarea></div><div class="input-group"><label>Attachment URL (Image/PDF - Optional)</label><input type="url" name="fileUrl"></div><button type="submit" class="btn">Post Notice</button></form></div><div class="table-wrapper"><h2>Posted Notices</h2><table id="noticesTable"><thead><tr><th>Date</th><th>Title</th><th>Action</th></tr></thead><tbody></tbody></table></div>`; }
    function getBillingManagementHTML() { return `<div class="form-wrapper"><h2>Create New Bill</h2><form id="addBillForm"><div class="grid-container"><div class="input-group"><label>Select Student</label><select name="studentId" id="billStudentSelector" required></select></div><div class="input-group"><label>Bill Title</label><input type="text" name="title" required></div><div class="input-group"><label>Amount (BDT)</label><input type="number" name="amount" required></div><div class="input-group"><label>Due Date</label><input type="date" name="dueDate" required></div></div><button type="submit" class="btn">Create Bill</button></form></div><div class="table-wrapper"><h2>Recent Bills</h2><div id="recentBillsList"></div></div>`; }
    
    function getStudentDashboardHTML() { return `<div class="grid-container"><div class="card"><h3>আজকের ক্লাস রুটিন</h3><div id="student-today-routine"></div></div><div class="card"><h3>সাম্প্রতিক নোটিশ</h3><div id="student-recent-notices"></div></div></div>`; }
    function getStudentHomeworkHTML() { return `<div class="card"><h2><i class="fas fa-book-open"></i> দৈনিক বাড়ির কাজ</h2><div id="student-homework-list"></div></div>`; }
    function getStudentSchedulesHTML() { return `<div class="card"><h2><i class="fas fa-calendar-alt"></i> সাপ্তাহিক ক্লাস রুটিন</h2><div id="student-schedule-display" class="schedule-grid"></div></div>`; }
    function getStudentAttendanceHTML() { return `<div class="card"><h2><i class="fas fa-user-check"></i> মাসিক হাজিরা রিপোর্ট</h2><p>সবুজ=উপস্থিতি, লাল=অনুপস্থিতি</p><div id="student-attendance-calendar"></div></div>`; }
    function getStudentResultsHTML() { return `<div class="card"><h2><i class="fas fa-poll"></i> পরীক্ষার ফলাফল</h2><div id="student-exam-results-list"></div></div>`; }
    function getStudentBillingHTML() { return `<div class="grid-container" style="grid-template-columns: 2fr 1fr;"><div class="card"><h2>বকেয়া বিলসমূহ</h2><table id="student-due-bills-table"></table></div><div class="card"><h2>বিল পরিশোধ করুন</h2><p>সকল বিল ঘরে বসেই পরিশোধ করুন।</p><div class="payment-methods"><img src="https://i.ibb.co/qj8pvTh/b-Kash-logo.png" alt="bKash"><img src="https://i.ibb.co/P9fG11c/rocket-logo.png" alt="Rocket"><img src="https://i.ibb.co/hZjzVpD/nogod-logo.png" alt="Nagad"></div><button class="btn" style="margin-top: 20px;">অনলাইনে পেমেন্ট করুন</button></div></div><div class="card"><h2>পূর্ববর্তী রশিদ</h2><table id="student-payment-history-table"></table></div>`; }
    function getStudentNoticesHTML() { return `<div class="card"><h2><i class="fas fa-bell"></i> সকল নোটিশ</h2><div id="student-all-notices-list"></div></div>`; }
    
    // Data Population Functions
    function populateAdminDashboard(){ 
        document.getElementById('total-students').textContent = Object.keys(appState.students || {}).length;
        document.getElementById('total-teachers').textContent = Object.keys(appState.teachers || {}).length + Object.keys(appState.librarians || {}).length;
        document.getElementById('total-classes').textContent = Object.keys(appState.classes || {}).length; 
        document.getElementById('total-books').textContent = Object.keys(appState.library?.books || {}).length; 
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        const today = new Date().toISOString().slice(0,10);
        const todaysAttendance = appState.attendance?.[today] || {};
        const classData = {};
        Object.entries(appState.students || {}).forEach(([id, student]) => {
            const key = `${student.className}___${student.section}`;
            if (!classData[key]) classData[key] = { present: 0, total: 0 };
            classData[key].total++;
            if (todaysAttendance[key]?.[id]?.status === 'present') {
                classData[key].present++;
            }
        });
        const labels = Object.keys(classData).map(c => c.replace('___', ' - '));
        const percentages = Object.values(classData).map(data => data.total > 0 ? (data.present / data.total) * 100 : 0);
        if(attendanceChart) { attendanceChart.destroy(); }
        Chart.defaults.color = '#d2dae2';
        attendanceChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Attendance Rate (%)', data: percentages, backgroundColor: 'rgba(0, 168, 255, 0.6)', borderColor: 'rgba(0, 168, 255, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, max: 100, grid: { color: 'rgba(210, 218, 226, 0.2)' } }, x: { grid: { color: 'rgba(210, 218, 226, 0.2)' } } }, responsive: true, maintainAspectRatio: false } }); 
    }
    function populateTeacherDashboard() {
        const container = document.getElementById('todaysClassesList');
        if(!container) return;
        const dayMap = [1, 2, 3, 4, 5, -1, 0];
        const formDayIndex = dayMap[new Date().getDay()];
        const todaysSchedules = Object.values(appState.schedules || {}).filter(s => s.teacherId === appState.user.uid && parseInt(s.day) === formDayIndex).sort((a, b) => a.startTime.localeCompare(b.startTime));
        container.innerHTML = (todaysSchedules.length === 0) ? `<p>You have no classes today.</p>` : todaysSchedules.map(s => `<div class="schedule-card"><h4>${s.className} (${s.section})</h4><p><strong>Subject:</strong> ${s.subject}</p><p><strong>Time:</strong> ${s.startTime} - ${s.endTime}</p></div>`).join('');
        populateMyWeeklySchedule();
        populateMyDuties();
    }
    function populateStudentTable() {
        const tbody = document.getElementById('allStudentsTableBody');
        tbody.innerHTML = '';
        Object.entries(appState.students || {}).sort(([,a],[,b])=> a.className.localeCompare(b.className) || a.roll - b.roll).forEach(([id, s]) => {
            tbody.innerHTML += `<tr><td><img src="${s.profilePicUrl || 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'}" class="profile-pic" onerror="this.src='https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'"></td><td>${s.name}</td><td>${s.className} (${s.section})</td><td>${s.roll}</td><td><div class="action-buttons"><button class="btn" style="padding: 5px 10px; font-size: 0.9rem; margin:0;" onclick="navigateTo('student-profile', { id: '${id}' })">View</button>${appState.user.role === 'admin' ? `<button class="action-btn edit-btn" onclick="openEditModal('student', '${id}')"><i class="fas fa-edit"></i></button><button class="action-btn delete-btn" onclick="deleteItem('${id}', 'students')"><i class="fas fa-trash"></i></button>` : ''}</div></td></tr>`;
        });
    }
    function populateTeachersTable() {
        const table = document.getElementById('teachersTable');
        table.innerHTML = '<thead><tr><th>Photo</th><th>Name</th><th>Role</th><th>Responsibility</th><th>Email</th><th>Action</th></tr></thead><tbody></tbody>';
        const tbody = table.querySelector('tbody');
        Object.entries(appState.teachers || {}).forEach(([uid, t]) => { tbody.innerHTML += `<tr><td><img src="${t.profilePicUrl || 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'}" class="profile-pic"></td><td>${t.name}</td><td>Teacher</td><td>${t.subject}</td><td>${t.email}</td><td><div class="action-buttons"><button class="action-btn edit-btn" onclick="openEditModal('teacher', '${uid}')"><i class="fas fa-edit"></i></button><button class="action-btn delete-btn" onclick="deleteStaff('${uid}', 'teacher')"><i class="fas fa-trash"></i></button></div></td></tr>`; });
        Object.entries(appState.librarians || {}).forEach(([uid, l]) => { tbody.innerHTML += `<tr><td><img src="${l.profilePicUrl || 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'}" class="profile-pic"></td><td>${l.name}</td><td>Librarian</td><td>Library</td><td>${l.email}</td><td><div class="action-buttons"><button class="action-btn edit-btn" onclick="openEditModal('librarian', '${uid}')"><i class="fas fa-edit"></i></button><button class="action-btn delete-btn" onclick="deleteStaff('${uid}', 'librarian')"><i class="fas fa-trash"></i></button></div></td></tr>`; });
    }
    function populateScheduleGrid() {
        const container = document.getElementById('schedule-display');
        if(!container) return;
        const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"];
        container.innerHTML = days.map((day, i) => `<div class="day-column"><h3>${day}</h3><div id="day-${i}"></div></div>`).join('');
        const filter = document.getElementById('routineFilter');
        const classes = [...new Set(Object.values(appState.schedules || {}).map(s => `${s.className}___${s.section}`))];
        const currentFilterValue = filter.value;
        filter.innerHTML = '<option value="all">All Classes</option>' + classes.sort().map(c => { const [className, section] = c.split('___'); return `<option value="${c}">${className} (${section})</option>`; }).join('');
        filter.value = currentFilterValue;
        let schedulesToDisplay = Object.entries(appState.schedules || {});
        if (filter.value !== 'all') {
            const [className, section] = filter.value.split('___');
            schedulesToDisplay = schedulesToDisplay.filter(([,s]) => s.className === className && s.section === section);
        }
        schedulesToDisplay.forEach(([id, s]) => {
            const dayContainer = document.getElementById(`day-${s.day}`);
            if (dayContainer) {
                const teacherName = appState.teachers[s.teacherId]?.name || 'Unknown';
                dayContainer.innerHTML += `<div class="schedule-card">${appState.user.role === 'admin' ? `<div class="schedule-actions"><button class="action-btn edit-btn" onclick="openEditModal('schedule', '${id}')"><i class="fas fa-edit"></i></button><button class="action-btn delete-btn" onclick="deleteItem('${id}', 'schedules')"><i class="fas fa-trash"></i></button></div>` : ''}<p><strong>${s.className} (${s.section})</strong></p><p>Subject: ${s.subject}</p><p>Teacher: ${teacherName}</p><p>Time: ${s.startTime} - ${s.endTime}</p></div>`;
            }
        });
    }
    function populateMyWeeklySchedule() {
        const container = document.getElementById('my-weekly-schedule');
        if (!container) return;
        const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"];
        container.innerHTML = days.map((day, i) => `<div class="day-column"><h3>${day}</h3><div id="my-day-${i}"></div></div>`).join('');
        Object.values(appState.schedules || {}).filter(s => s.teacherId === appState.user.uid).forEach(s => {
            const dayContainer = document.getElementById(`my-day-${s.day}`);
            if (dayContainer) {
                dayContainer.innerHTML += `<div class="schedule-card"><p><strong>${s.className} (${s.section})</strong></p><p>Subject: ${s.subject}</p><p>Time: ${s.startTime} - ${s.endTime}</p></div>`;
            }
        });
    }

    function populateMyDuties() {
        const dutyContainer = document.getElementById('my-duties');
        if (!dutyContainer) return;
        const myId = appState.user.uid;
        let dutiesHtml = '';
        Object.entries(appState.invigilatorRosters || {}).forEach(([examId, dates]) => {
            const exam = appState.mainExams[examId];
            Object.entries(dates).forEach(([date, rooms]) => {
                Object.entries(rooms).forEach(([roomId, teacherId]) => {
                    if (teacherId === myId) {
                        const room = appState.rooms[roomId];
                        dutiesHtml += `<div class="schedule-card"><p><strong>${exam.name}</strong></p><p><strong>Date:</strong> ${date}</p><p><strong>Room:</strong> ${room.name}</p></div>`;
                    }
                });
            });
        });
        dutyContainer.innerHTML = dutiesHtml || '<p>You have no upcoming duties.</p>';
    }
    function populateSettingsPage() {
        populateList(appState.classes, 'classList', 'classes');
        populateList(appState.sections, 'sectionList', 'sections');
        const settings = appState.settings || {};
        document.getElementById('schoolName').value = settings.schoolName || '';
        document.getElementById('schoolLogoUrl').value = settings.schoolLogoUrl || '';
        document.getElementById('principalName').value = settings.principalName || '';
        document.getElementById('principalSignatureUrl').value = settings.principalSignatureUrl || '';
    }
    function populateAttendancePage() {
        populateClassSectionDropdown('attendanceClassSelector');
        document.getElementById('attendanceClassSelector').onchange = loadStudentsForAttendance;
        document.getElementById('attendanceDate').onchange = loadStudentsForAttendance;
    }
    function loadStudentsForAttendance() {
        const classSection = document.getElementById('attendanceClassSelector').value;
        const date = document.getElementById('attendanceDate').value;
        const studentListDiv = document.getElementById('attendanceStudentList');
        const saveBtn = document.getElementById('saveAttendanceBtn');
        const actionsDiv = document.getElementById('attendance-actions');
        if (!classSection || !date) { studentListDiv.innerHTML = '<p>Please select a class and date.</p>'; saveBtn.style.display = 'none'; actionsDiv.style.display = 'none'; return; }
        actionsDiv.style.display = 'block';
        const [className, section] = classSection.split('___');
        const students = Object.entries(appState.students || {}).filter(([,s]) => s.className === className && s.section === section).sort(([,a],[,b])=> a.roll - b.roll);
        if (students.length === 0) { studentListDiv.innerHTML = '<p>No students found.</p>'; saveBtn.style.display = 'none'; return; }
        let html = '';
        const todaysAttendance = appState.attendance?.[date]?.[classSection] || {};
        students.forEach(([id, student]) => {
            const status = todaysAttendance[id]?.status || 'present';
            html += `<div class="attendance-row"><span>${student.roll}. ${student.name}</span><div class="attendance-status"><input type="radio" id="present_${id}" name="status_${id}" value="present" ${status === 'present' ? 'checked' : ''}><label for="present_${id}">Present</label><input type="radio" id="absent_${id}" name="status_${id}" value="absent" ${status === 'absent' ? 'checked' : ''}><label for="absent_${id}">Absent</label></div></div>`;
        });
        studentListDiv.innerHTML = html;
        saveBtn.style.display = 'block';
    }
    function populateClassTestsPage() {
        populateDropdown(appState.classes, 'examClass');
        populateDropdown(appState.sections, 'examSection');
        const tbody = document.querySelector('#examsTable tbody');
        tbody.innerHTML = '';
        const myExams = Object.entries(appState.exams || {}).filter(([,exam]) => exam.createdBy === appState.user.uid);
        if (myExams.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No tests created.</td></tr>'; return; }
        myExams.forEach(([id, exam]) => {
            tbody.innerHTML += `<tr><td>${exam.examName}</td><td>${exam.className} (${exam.section})</td><td>${exam.subject}</td><td>${exam.totalMarks}</td><td><button class="btn" style="padding: 5px 10px; font-size: 0.9rem; width: auto;" onclick="openMarkEntryModal('${id}')">Enter Marks</button><button class="action-btn delete-btn" onclick="deleteItem('${id}', 'exams')"><i class="fas fa-trash"></i></button></td></tr>`;
        });
    }
    function populateStudentProfilePage(params) {
        if (!params || !params.id) return;
        const student = appState.students[params.id]; if (!student) return;
        document.getElementById('profile-details').innerHTML = `<img src="${student.profilePicUrl || 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'}" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; display: block; margin: 0 auto 20px; border: 4px solid var(--primary-color);"><h2 style="text-align: center; color: var(--primary-color);">${student.name}</h2><p style="text-align:center; margin-top:10px;"><strong>Class:</strong> ${student.className} (${student.section})</p><p style="text-align:center;"><strong>Roll:</strong> ${student.roll}</p><p style="text-align:center;"><strong>Guardian:</strong> ${student.guardianName}</p><p style="text-align:center;"><strong>Contact:</strong> ${student.contact}</p>`;
        const resultsDiv = document.getElementById('profile-exam-results'); let tableHTML = '<table><thead><tr><th>Test Name</th><th>Subject</th><th>Marks</th><th>Total</th></tr></thead><tbody>'; let hasResults = false;
        Object.entries(appState.marks || {}).forEach(([examId, examMarks]) => {
            if(examMarks[params.id]){
                const exam = appState.exams[examId];
                if(exam) { hasResults = true; tableHTML += `<tr><td>${exam.examName}</td><td>${exam.subject}</td><td>${examMarks[params.id].marksObtained}</td><td>${exam.totalMarks}</td></tr>`; }
            }
        });
        if (!hasResults) tableHTML += '<tr><td colspan="4" style="text-align:center;">No results found.</td></tr>';
        resultsDiv.innerHTML = tableHTML + '</tbody></table>';
        const libraryDiv = document.getElementById('profile-library-books');
        let libraryHTML = '<table><thead><tr><th>Book Title</th><th>Issue Date</th><th>Due Date</th></tr></thead><tbody>';
        const issuedBooks = Object.values(appState.library?.issuedBooks || {}).filter(issue => issue.studentId === params.id && issue.status === 'issued');
        if (issuedBooks.length > 0) { issuedBooks.forEach(issue => { const book = appState.library.books[issue.bookId]; if(book) { libraryHTML += `<tr><td>${book.title}</td><td>${issue.issueDate}</td><td>${issue.dueDate}</td></tr>`; }}); } 
        else { libraryHTML += '<tr><td colspan="3" style="text-align:center;">No books issued.</td></tr>'; }
        libraryDiv.innerHTML = libraryHTML + '</tbody></table>';
    }
    function populateExamManagementPage() { 
        document.getElementById('mainExamsList').innerHTML = '<table><thead><tr><th>Name</th><th>Date</th><th>Actions</th></tr></thead><tbody>' + Object.entries(appState.mainExams || {}).map(([id, exam]) => `<tr><td>${exam.name}</td><td>${exam.date}</td><td><div class="action-buttons"><button class="action-btn edit-btn" onclick="openEditModal('mainExam', '${id}')" title="Routine"><i class="fas fa-calendar-alt"></i></button><button class="btn" onclick="generateExamRoutinePdf(event, '${id}')" style="margin:0; padding: 5px 12px; font-size: 0.8rem; background: var(--success-color);">PDF</button><button class="action-btn delete-btn" onclick="deleteItem('${id}', 'mainExams')"><i class="fas fa-trash"></i></button></div></td></tr>`).join('') + '</tbody></table>';
        document.getElementById('roomsList').innerHTML = '<table><thead><tr><th>Name</th><th>Capacity</th><th>Action</th></tr></thead><tbody>' + Object.entries(appState.rooms || {}).map(([id, room]) => `<tr><td>${room.name}</td><td>${room.capacity}</td><td><button class="action-btn delete-btn" onclick="deleteItem('${id}', 'rooms')"><i class="fas fa-trash"></i></button></td></tr>`).join('') + '</tbody></table>';
        populateDropdownWithKeys(appState.mainExams, 'seatPlanExamSelect', item => item.name);
        populateDropdown(appState.classes, 'seatPlanClassSelect');
        populateDropdownWithKeys(appState.rooms, 'seatPlanRoomSelect', item => `${item.name} (Cap: ${item.capacity})`, true);
        populateDropdownWithKeys(appState.mainExams, 'rosterExamSelect', item => item.name);
    }
    function populateLibraryManagementPage() {
        populateBooksTable();
        populateIssuedBooksTable();
        populateDropdownWithKeys(appState.library?.books || {}, 'issueBookId', book => `${book.title} | Avail: ${book.availableQuantity}`);
        populateDropdownWithKeys(appState.students || {}, 'issueStudentId', student => `${student.name} (${student.className})`);
    }
    function populateAdmissionManagementPage() {
        const applications = appState.admissionApplications || {};
        const tbody = document.querySelector('#applicationsTable tbody');
        tbody.innerHTML = '';
        if (Object.keys(applications).length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No pending applications.</td></tr>'; return; }
        Object.entries(applications).forEach(([id, app]) => { tbody.innerHTML += `<tr><td>${app.studentName}</td><td>${app.className}</td><td>${app.guardianContact}</td><td><div class="action-buttons"><button class="action-btn edit-btn" onclick="openEditModal('admissionApplication', '${id}')" title="View/Edit"><i class="fas fa-edit"></i></button><button class="btn" style="background: var(--success-color); padding: 5px 10px; font-size: 0.9rem;" onclick="approveApplication('${id}')">Approve</button><button class="btn" style="background: var(--danger-color); padding: 5px 10px; font-size: 0.9rem;" onclick="rejectApplication('${id}')">Reject</button></div></td></tr>`; });
        populateList(appState.admissionSettings?.formClasses || {}, 'admissionClassList', 'admissionSettings/formClasses');
    }
    function populateHomeworkManagementPage() {
        populateClassSectionDropdown('homeworkClassSelector');
        const homeworkList = document.getElementById('homeworkList');
        homeworkList.innerHTML = '';
        Object.entries(appState.homework || {}).forEach(([classSection, dates]) => {
            Object.entries(dates).forEach(([date, homeworks]) => {
                Object.entries(homeworks).forEach(([id, hw]) => {
                    homeworkList.innerHTML += `<div class="homework-item">${date} - <strong>${classSection.replace('___','-')}</strong>: ${hw.subject} <button class="action-btn delete-btn" onclick="deleteItem('${id}', 'homework/${classSection}/${date}')"><i class="fas fa-trash"></i></button></div>`;
                });
            });
        });
    }
    function populateNoticeManagementPage() {
        const tbody = document.querySelector('#noticesTable tbody');
        tbody.innerHTML = '';
        Object.entries(appState.notices || {}).sort(([,a], [,b]) => b.createdAt.localeCompare(a.createdAt)).forEach(([id, notice]) => {
            tbody.innerHTML += `<tr><td>${new Date(notice.createdAt).toLocaleDateString()}</td><td>${notice.title}</td><td><button class="action-btn delete-btn" onclick="deleteItem('${id}', 'notices')"><i class="fas fa-trash"></i></button></td></tr>`;
        });
    }
    function populateBillingManagementPage() {
        populateDropdownWithKeys(appState.students, 'billStudentSelector', s => `${s.name} (${s.className} - ${s.roll})`);
    }

    function populateStudentDashboard() {
        const student = appState.user;
        const dayMap = [1, 2, 3, 4, 5, -1, 0];
        const today = dayMap[new Date().getDay()];
        const routineContainer = document.getElementById('student-today-routine');
        const todaySchedules = Object.values(appState.schedules || {}).filter(s => s.className === student.className && s.section === student.section && parseInt(s.day) === today);
        let routineHTML = '<table><tbody>';
        todaySchedules.forEach(item => { routineHTML += `<tr><td><strong>${item.startTime}</strong></td><td>${item.subject} (${appState.teachers[item.teacherId]?.name || 'N/A'})</td></tr>`; });
        routineContainer.innerHTML = todaySchedules.length ? routineHTML + '</tbody></table>' : '<p>আজ কোনো ক্লাস নেই।</p>';
        const noticesContainer = document.getElementById('student-recent-notices');
        let noticesHTML = '';
        Object.values(appState.notices || {}).slice(0, 3).forEach(notice => { noticesHTML += `<div class="notice-item"><div class="date">${new Date(notice.createdAt).toLocaleDateString()}</div><p><strong>${notice.title}</strong></p></div>`; });
        noticesContainer.innerHTML = noticesHTML || '<p>কোনো নতুন নোটিশ নেই।</p>';
    }
    function populateStudentHomework() {
        const student = appState.user;
        const classSectionKey = `${student.className}___${student.section}`;
        const homeworkData = appState.homework?.[classSectionKey] || {};
        const list = document.getElementById('student-homework-list');
        list.innerHTML = '';
        Object.entries(homeworkData).sort((a,b) => b[0].localeCompare(a[0])).forEach(([date, homeworks]) => {
            Object.values(homeworks).forEach(hw => {
                list.innerHTML += `<div class="homework-item"><div class="date">${date} | <strong>বিষয়:</strong> ${hw.subject} | <strong>শিক্ষক:</strong> ${hw.teacherName || 'N/A'}</div><p>${hw.details}</p>${hw.attachmentUrl ? `<a href="${hw.attachmentUrl}" target="_blank"><i class="fas fa-paperclip"></i> সংযুক্তি দেখুন</a>` : ''}</div>`;
            });
        });
        if (!list.innerHTML) list.innerHTML = '<p>কোনো বাড়ির কাজ পাওয়া যায়নি।</p>';
    }
    function populateStudentSchedule() {
        const student = appState.user;
        const container = document.getElementById('student-schedule-display');
        const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"];
        container.innerHTML = days.map((day, i) => `<div class="day-column"><h3>${day}</h3><div id="student-day-${i}"></div></div>`).join('');
        Object.values(appState.schedules || {}).filter(s => s.className === student.className && s.section === student.section).forEach(s => {
            const dayContainer = document.getElementById(`student-day-${s.day}`);
            if (dayContainer) dayContainer.innerHTML += `<div class="schedule-card"><p><strong>${s.subject}</strong></p><p>শিক্ষক: ${appState.teachers[s.teacherId]?.name || 'N/A'}</p><p>সময়: ${s.startTime} - ${s.endTime}</p></div>`;
        });
    }
    function populateStudentAttendance() {
        const student = appState.user;
        const calendar = document.getElementById('student-attendance-calendar');
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let calendarHTML = `<div style="display: flex; flex-wrap: wrap; gap: 5px;">`;
        for (let i = 1; i <= daysInMonth; i++) {
            const date = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const classSection = `${student.className}___${student.section}`;
            const status = appState.attendance?.[date]?.[classSection]?.[student.id]?.status;
            let color = '#57606f';
            if (status === 'present') color = 'rgba(76, 209, 55, 0.7)';
            else if (status === 'absent') color = 'rgba(232, 65, 24, 0.7)';
            calendarHTML += `<div style="width: 40px; height: 40px; background: ${color}; display: grid; place-items: center; border-radius: 5px; border: 1px solid #4a4a4a;">${i}</div>`;
        }
        calendar.innerHTML = calendarHTML + `</div>`;
    }
    function populateStudentResults() {
        const studentId = appState.user.id;
        const list = document.getElementById('student-exam-results-list');
        let html = `<table><thead><tr><th>পরীক্ষার নাম</th><th>বিষয়</th><th>প্রাপ্ত নম্বর</th><th>মোট নম্বর</th></tr></thead><tbody>`;
        let hasResults = false;
        Object.entries(appState.marks || {}).forEach(([examId, studentsMarks]) => {
            if(studentsMarks[studentId]) {
                hasResults = true;
                const exam = appState.exams[examId];
                const mark = studentsMarks[studentId];
                html += `<tr><td>${exam.examName}</td><td>${exam.subject}</td><td>${mark.marksObtained}</td><td>${exam.totalMarks}</td></tr>`;
            }
        });
        if(!hasResults) html += `<tr><td colspan="4" style="text-align: center;">কোনো পরীক্ষার ফলাফল পাওয়া যায়নি।</td></tr>`;
        list.innerHTML = html + `</tbody></table> <button class="btn" style="width: auto; margin-top:20px;" onclick="generateReportCardPdf(event, '${studentId}')"><i class="fas fa-file-pdf"></i> সম্পূর্ণ রিপোর্ট কার্ড ডাউনলোড</button>`;
    }
    function populateStudentBilling() {
        const studentId = appState.user.id;
        const dueBills = Object.values(appState.bills || {}).filter(bill => bill.studentId === studentId && bill.status === 'due');
        const dueTable = document.getElementById('student-due-bills-table');
        let dueHtml = '<thead><tr><th>বিলের বিবরণ</th><th>পরিমাণ (টাকা)</th><th>শেষ তারিখ</th><th>অবস্থা</th></tr></thead><tbody>';
        dueBills.forEach(bill => { dueHtml += `<tr><td>${bill.title}</td><td>${bill.amount}</td><td>${bill.dueDate}</td><td><span style="color:var(--danger-color);">বকেয়া</span></td></tr>`; });
        if (dueBills.length === 0) dueHtml += '<tr><td colspan="4" style="text-align:center;">কোনো বকেয়া বিল নেই।</td></tr>';
        dueTable.innerHTML = dueHtml + '</tbody>';
    }
    function populateStudentNotices() {
        const list = document.getElementById('student-all-notices-list');
        list.innerHTML = '';
        Object.values(appState.notices || {}).forEach(notice => { list.innerHTML += `<div class="notice-item"><div class="date">${new Date(notice.createdAt).toLocaleDateString()}</div><p><strong>${notice.title}</strong></p><p>${notice.content}</p>${notice.fileUrl ? `<a href="${notice.fileUrl}" target="_blank"><i class="fas fa-file-pdf"></i> বিস্তারিত ফাইল</a>` : ''}</div>`; });
        if(!list.innerHTML) list.innerHTML = '<p>কোনো নোটিশ নেই।</p>';
    }

    // --- Form submission logic is unchanged ---
    function handleFormSubmits(e) {
        e.preventDefault();
        const form = e.target;
        const button = form.querySelector('button[type="submit"]');
        button.disabled = true; button.textContent = 'Processing...';
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const schoolId = appState.schoolId;

        const actions = {
            'addHomeworkForm': () => {
                const classSection = document.getElementById('homeworkClassSelector').value;
                if (!classSection) return Promise.reject(new Error("Please select a class."));
                data.teacherId = appState.user.uid; data.teacherName = appState.user.name;
                return db.ref(`schools/${schoolId}/homework/${classSection}/${data.date}`).push(data).then(() => { alert('Homework added!'); form.reset(); });
            },
            'addNoticeForm': () => { data.createdAt = new Date().toISOString(); return db.ref(`schools/${schoolId}/notices`).push(data).then(() => { alert('Notice posted!'); form.reset(); }); },
            'addBillForm': () => { data.status = 'due'; data.createdAt = new Date().toISOString(); return db.ref(`schools/${schoolId}/bills`).push(data).then(() => { alert('Bill created!'); form.reset(); }); },
            'addStudentForm': () => db.ref(`schools/${schoolId}/students`).push(data).then(() => { alert('Student added!'); form.reset(); navigateTo('student-list'); }),
            'addStaffForm': () => {
                return secondaryAuth.createUserWithEmailAndPassword(data.email, data.password).then(cred => {
                    const staffData = {name: data.name, phone: data.phone, email: data.email, profilePicUrl: data.profilePicUrl, subject: data.subject || null};
                    const updates = {};
                    updates[`schools/${schoolId}/${data.role}s/${cred.user.uid}`] = staffData;
                    updates[`schools/${schoolId}/roles/${data.role}s/${cred.user.uid}`] = true;
                    updates[`user_school_map/${cred.user.uid}`] = schoolId;
                    return db.ref().update(updates);
                }).then(() => { alert('Staff added!'); form.reset(); secondaryAuth.signOut(); });
            },
            'addScheduleForm': () => db.ref(`schools/${schoolId}/schedules`).push(data).then(() => { alert('Schedule added!'); form.reset(); }),
            'addClassForm': () => db.ref(`schools/${schoolId}/classes`).push({ name: document.getElementById('newClassName').value.trim() }).then(() => form.reset()),
            'addSectionForm': () => db.ref(`schools/${schoolId}/sections`).push({ name: document.getElementById('newSectionName').value.trim() }).then(() => form.reset()),
            'addAdmissionClassForm': () => db.ref(`schools/${schoolId}/admissionSettings/formClasses`).push({ name: document.getElementById('newAdmissionClassName').value.trim() }).then(() => form.reset()),
            'schoolSettingsForm': () => db.ref(`schools/${schoolId}/settings`).update(data).then(() => alert('Settings saved!')),
            'editForm': () => {
                const path = form.dataset.type === 'admissionApplication' ? `admissionApplications/${form.dataset.id}` : `students/${form.dataset.id}`;
                return db.ref(`schools/${schoolId}/${path}`).update(data).then(() => { alert('Updated!'); closeModal(); });
            },
            'addExamForm': () => { data.createdBy = appState.user.uid; return db.ref(`schools/${schoolId}/exams`).push(data).then(() => { alert('Test created!'); form.reset(); }); },
            'attendanceForm': () => {
                const date = document.getElementById('attendanceDate').value; const classSection = document.getElementById('attendanceClassSelector').value;
                const updates = {};
                for(const [key, value] of formData.entries()){ updates[`/schools/${schoolId}/attendance/${date}/${classSection}/${key.replace('status_','')}`] = { status: value }; }
                return db.ref().update(updates).then(() => alert('Attendance saved!'));
            },
            'markEntryForm': () => {
                const examId = form.dataset.examId; const updates = {};
                for(const [key, value] of formData.entries()){ if (value.trim() !== '') updates[`/schools/${schoolId}/marks/${examId}/${key}`] = { marksObtained: parseFloat(value) }; }
                return db.ref().update(updates).then(() => { alert('Marks saved!'); closeModal(); });
            },
            'addMainExamForm': () => db.ref(`schools/${schoolId}/mainExams`).push(data).then(() => { alert('Exam added!'); form.reset(); }),
            'addRoomForm': () => db.ref(`schools/${schoolId}/rooms`).push(data).then(() => { alert('Room added!'); form.reset(); }),
            'examRoutineForm': () => {
                const updates = {};
                for (const [key, value] of formData.entries()) { if (value) updates[`/schools/${appState.schoolId}/mainExams/${form.dataset.examId}/routine/${key}`] = value; }
                return db.ref().update(updates).then(() => { alert('Routine saved!'); closeModal(); });
            },
            'addBookForm': () => { data.availableQuantity = parseInt(data.totalQuantity); return db.ref(`schools/${schoolId}/library/books`).push(data).then(() => { alert('Book added!'); form.reset(); }); },
            'issueBookForm': () => {
                const book = appState.library.books[data.bookId];
                if (!book || book.availableQuantity < 1) return Promise.reject(new Error("Book unavailable."));
                const issueData = {bookId: data.bookId, studentId: data.studentId, issueDate: new Date().toISOString().slice(0, 10), dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10), status: 'issued'};
                const updates = {};
                updates[`schools/${schoolId}/library/books/${data.bookId}/availableQuantity`] = book.availableQuantity - 1;
                updates[`schools/${schoolId}/library/issuedBooks/${db.ref().push().key}`] = issueData;
                return db.ref().update(updates).then(() => { alert('Book issued!'); form.reset(); });
            }
        };

        const action = actions[form.id];
        if (action) {
            action().catch(err => alert("Error: " + err.message))
                  .finally(() => { 
                      button.disabled = false; 
                      const originalText = form.id.includes('add') ? (form.id === 'addStaffForm' ? 'Add Staff' : 'Add') : 'Save Changes';
                      button.textContent = (form.id === 'addStudentForm') ? 'Add Student' : originalText;
                  });
        } else { button.disabled = false; }
    }

    function openLoginTab(evt, tabName) {
        document.querySelectorAll('#login-box .tab-content').forEach(tc => tc.classList.remove('active'));
        document.querySelectorAll('#login-box .tab-link').forEach(tl => tl.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    }
    function attachEventListeners() { 
        document.body.addEventListener('click', e => { 
            const navLink = e.target.closest('#app-wrapper .nav-link'); 
            if (navLink) { 
                e.preventDefault(); 
                if(navLink.id === 'logout-btn') { mainAuth.signOut().then(() => window.location.reload()); return; } 
                navigateTo(navLink.getAttribute('href').substring(1)); 
            } 
            if (e.target.closest('#hamburger-menu')) document.getElementById('sidebar').classList.toggle('active'); 
        }); 
        document.body.addEventListener('submit', handleFormSubmits); 
    }
    function attachStudentEventListeners() {
        document.body.addEventListener('click', e => {
            const navLink = e.target.closest('#student-app-wrapper .student-nav-link');
            if (navLink) { e.preventDefault(); navigateToStudentPage(navLink.getAttribute('href').substring(1)); }
            if (e.target.closest('#student-logout-btn')) { if (confirm('আপনি কি লগআউট করতে চান?')) window.location.reload(); }
            if (e.target.closest('#student-hamburger-menu')) { document.getElementById('student-sidebar').classList.toggle('active'); }
        });
    }
    function closeModal() { document.getElementById('editModal').style.display = "none"; }
    window.onclick = (event) => { if (event.target == document.getElementById('editModal')) closeModal(); }
    function deleteItem(id, path) { if (confirm('Are you sure?')) db.ref(`schools/${appState.schoolId}/${path}/${id}`).remove().catch(err => alert(err.message)); }
    function deleteStaff(uid, role) { if (confirm(`Are you sure you want to delete this ${role}?`)) alert("Deletion restricted in demo."); }
    function openTab(evt, tabName) {
        const parent = evt.target.closest('.tabs').nextElementSibling.parentElement;
        parent.querySelectorAll('.tab-content').forEach(tc => tc.style.display = "none");
        parent.querySelectorAll('.tab-link').forEach(tl => tl.classList.remove('active'));
        parent.querySelector('#' + tabName).style.display = "block";
        evt.currentTarget.classList.add('active');
    }
    function populateAllDropdowns() {
        populateDropdown(appState.classes, 'studentClass');
        populateDropdown(appState.sections, 'studentSection');
        populateDropdown(appState.classes, 'scheduleClass');
        populateDropdown(appState.sections, 'scheduleSection');
        populateDropdownWithKeys(appState.teachers, 'scheduleTeacher', item => `${item.name} (${item.subject})`);
    }
    function populateDropdown(data, selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = `<option value="">Select...</option>` + Object.values(data || {}).map(item => `<option value="${item.name}">${item.name}</option>`).join('');
    }
    function populateDropdownWithKeys(data, selectId, formatter) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = `<option value="">Select...</option>` + Object.entries(data || {}).sort(([,a], [,b]) => a.name.localeCompare(b.name)).map(([id, item]) => `<option value="${id}">${formatter(item)}</option>`).join('');
    }
    function populateClassSectionDropdown(selectId) {
        const selector = document.getElementById(selectId); if (!selector) return;
        selector.innerHTML = '<option value="">Select Class & Section...</option>';
        Object.values(appState.classes || {}).forEach(c => {
            Object.values(appState.sections || {}).forEach(s => {
                selector.innerHTML += `<option value="${c.name}___${s.name}">${c.name} - ${s.name}</option>`;
            });
        });
    }
    function populateList(data, listId, path) {
        const list = document.getElementById(listId);
        if (!list) return;
        list.innerHTML = Object.entries(data || {}).map(([id, item]) => `<li style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #4a4a4a;">${item.name}<button class="action-btn delete-btn" onclick="deleteItem('${id}', '${path}')"><i class="fas fa-trash"></i></button></li>`).join('');
    }
    function toggleSubjectField() {
        document.getElementById('subject-input-group').style.display = (document.getElementById('staffRole').value === 'teacher') ? 'flex' : 'none';
    }

    function openEditModal(type, id) {
        const modal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        if (type === 'student') {
            const student = appState.students[id];
            modalTitle.textContent = `Edit ${student.name}`;
            modalBody.innerHTML = `
                <form id="editForm" data-type="student" data-id="${id}">
                    <div class="grid-container">
                        <div class="input-group"><label>Student Name</label><input type="text" name="name" value="${student.name || ''}" required></div>
                        <div class="input-group"><label>Roll Number</label><input type="text" name="roll" value="${student.roll || ''}" required></div>
                        <div class="input-group"><label>Email</label><input type="email" name="email" value="${student.email || ''}" required></div>
                        <div class="input-group"><label>Password</label><input type="text" name="password" value="${student.password || ''}" required></div>
                        <div class="input-group"><label>Guardian's Name</label><input type="text" name="guardianName" value="${student.guardianName || ''}" required></div>
                        <div class="input-group"><label>Contact</label><input type="text" name="contact" value="${student.contact || ''}" required></div>
                    </div>
                    <button type="submit" class="btn">Save Changes</button>
                </form>
            `;
        }
        // Add more 'else if' blocks here for other types like 'teacher', 'schedule', etc.
        modal.style.display = 'block';
    }

    // --- PDF & HELPER FUNCTIONS ---
    function updateButtonState(button, isProcessing) {
        if (!button) return;
        if (isProcessing) {
            button.dataset.originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> প্রসেসিং...`;
        } else {
            button.disabled = false;
            if(button.dataset.originalText) button.innerHTML = button.dataset.originalText;
        }
    }
    
    async function generateWordStyleRoutinePdf(event) {
        const button = event.target.closest('button');
        updateButtonState(button, true);
        
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
            alert("PDF library (jsPDF) failed to load. Please check your internet connection and refresh the page.");
            updateButtonState(button, false);
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            if (typeof doc.autoTable !== 'function') {
                alert("PDF Table library (jsPDF-AutoTable) failed to load. Please check your internet connection and refresh the page.");
                updateButtonState(button, false);
                return;
            }

            doc.setFontSize(18);
            doc.text(appState.settings.schoolName || 'School Name', 105, 15, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Class Routine', 105, 22, { align: 'center' });
            
            let schedules = Object.values(appState.schedules || {});
            const filter = document.getElementById('routineFilter').value;
            if (filter !== 'all') {
                const [className, section] = filter.split('___');
                schedules = schedules.filter(s => s.className === className && s.section === section);
            }

            const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"];
            const head = [['Time', 'Class', 'Subject', 'Teacher']];
            let startY = 30;

            days.forEach(dayName => {
                const dayIndex = days.indexOf(dayName);
                const daySchedules = schedules
                    .filter(s => parseInt(s.day) === dayIndex)
                    .sort((a,b) => a.startTime.localeCompare(b.startTime));

                if (daySchedules.length > 0) {
                    if (startY > 250) { 
                        doc.addPage();
                        startY = 15;
                    }
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(dayName, 14, startY);
                    
                    const body = daySchedules.map(s => [
                        `${s.startTime} - ${s.endTime}`,
                        `${s.className} (${s.section})`,
                        s.subject,
                        appState.teachers[s.teacherId]?.name || 'N/A'
                    ]);
                    
                    doc.autoTable({
                        head: head,
                        body: body,
                        startY: startY + 5,
                        theme: 'grid',
                        headStyles: { fillColor: [44, 62, 80] }
                    });
                    startY = doc.autoTable.previous.finalY + 15;
                }
            });

            doc.save('Class-Routine.pdf');
        } catch (error) {
            console.error("PDF Generation failed:", error);
            alert("An unexpected error occurred while generating the PDF.");
        } finally {
            updateButtonState(button, false);
        }
    }
    
    async function generatePdf(event, elementId, fileName) {
        const button = event.target.closest('button');
        updateButtonState(button, true);
        
        if (typeof window.html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
            alert("PDF generation libraries failed to load. Please check your connection and refresh.");
            updateButtonState(button, false);
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            const content = document.querySelector(elementId);
            const canvas = await html2canvas(content, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const ratio = canvasWidth / canvasHeight;
            let width = pdfWidth;
            let height = width / ratio;
            if (height > pdfHeight) {
                height = pdfHeight;
                width = height * ratio;
            }
            pdf.addImage(imgData, 'PNG', 0, 0, width, height);
            pdf.save(`${fileName}.pdf`);
        } catch (error) {
            console.error("PDF generation failed:", error);
            alert("Failed to generate PDF from content.");
        } finally {
            updateButtonState(button, false);
        }
    }
    
    async function generateReportCardPdf(event, studentId) {
        const button = event.target.closest('button');
        updateButtonState(button, true);
        alert('Report card PDF generation is a complex feature and needs to be implemented fully.');
        setTimeout(() => updateButtonState(button, false), 1000);
    }
    
    async function generateAttendanceReportPdf(event) {
        const button = event.target.closest('button');
        updateButtonState(button, true);

        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
            alert("PDF library (jsPDF) failed to load. Please check your internet connection and refresh.");
            updateButtonState(button, false);
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            if (typeof doc.autoTable !== 'function') {
                alert("PDF Table library (jsPDF-AutoTable) failed to load. Please check your internet connection and refresh.");
                updateButtonState(button, false);
                return;
            }

            const classSection = document.getElementById('attendanceClassSelector').value;
            const dateStr = document.getElementById('attendanceDate').value;
            if (!classSection || !dateStr) {
                alert("Please select a class and date first.");
                updateButtonState(button, false);
                return;
            }
            
            const [className, section] = classSection.split('___');
            const monthYear = new Date(dateStr).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            doc.setFontSize(16);
            doc.text(`${appState.settings.schoolName || 'School'}`, 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Monthly Attendance Report: ${className} (${section})`, 105, 22, { align: 'center' });
            doc.text(`Month: ${monthYear}`, 105, 29, { align: 'center' });

            const students = Object.entries(appState.students || {})
                .filter(([, s]) => s.className === className && s.section === section)
                .sort(([, a], [, b]) => a.roll - b.roll);
            
            const head = [['Roll', 'Name', 'Present', 'Absent', 'Attendance %']];
            const body = students.map(([id, student]) => {
                let present = 0, absent = 0;
                const attendanceData = appState.attendance || {};
                Object.keys(attendanceData).forEach(date => {
                    const status = attendanceData[date]?.[classSection]?.[id]?.status;
                    if (status === 'present') present++;
                    if (status === 'absent') absent++;
                });
                const total = present + absent;
                const percentage = total > 0 ? ((present / total) * 100).toFixed(2) + '%' : 'N/A';
                return [student.roll, student.name, present, absent, percentage];
            });

            doc.autoTable({
                head: head,
                body: body,
                startY: 35,
                theme: 'grid',
                headStyles: { fillColor: [44, 62, 80] }
            });

            doc.save(`Attendance-Report-${className}-${section}-${monthYear}.pdf`);
        } catch (error) {
            console.error("PDF Generation failed:", error);
            alert("An unexpected error occurred while generating the attendance report.");
        } finally {
            updateButtonState(button, false);
        }
    }
    
</script>
</body>
</html>
