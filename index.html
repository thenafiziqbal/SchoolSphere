
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolSphere web </title>


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.autotable.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --primary-color: #4a69bd;
        --secondary-color: #5d6d7e;
        --accent-color: #1abc9c;
        --bg-color: #f4f7f6;
        --sidebar-bg: #2c3e50;
        --text-color: #34495e;
        --card-bg: #ffffff;
        --success-color: #2ecc71;
        --danger-color: #e74c3c;
        --warning-color: #f39c12;
        --premium-color: #f1c40f;
        --shadow: 0 4px 25px rgba(0, 0, 0, 0.07);
        --border-radius: 10px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
    #login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #667eea, #764ba2); }
    #login-box { background: var(--card-bg); padding: 40px; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 90%; max-width: 420px; text-align: center; animation: fadeIn 0.5s; }
    #login-box h2 { margin-bottom: 25px; color: var(--primary-color); }
    .input-group { display: flex; flex-direction: column; margin-bottom: 15px; text-align: left; }
    .input-group label { margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
    .input-group input, .input-group select, .input-group textarea { padding: 12px; border: 1px solid #dfe6e9; border-radius: 8px; font-size: 1rem; width: 100%; transition: border-color 0.3s; }
    .input-group input:focus, .input-group select:focus { border-color: var(--primary-color); outline: none; }
    .btn { padding: 12px 25px; border: none; background-color: var(--primary-color); color: white; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; width: 100%; margin-top: 10px; }
    .btn:hover { background-color: #3b5998; transform: translateY(-2px); }
    .btn:disabled { background-color: #95a5a6; cursor: not-allowed; }
    #app-wrapper { display: none; flex-direction: row; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .sidebar { width: 260px; background-color: var(--sidebar-bg); color: white; display: flex; flex-direction: column; height: 100vh; position: fixed; z-index: 1000; transition: transform 0.3s ease-in-out; box-shadow: 2px 0 15px rgba(0,0,0,0.1); }
    .sidebar-header { display: flex; align-items: center; padding: 20px 15px; border-bottom: 1px solid #4a627a; flex-direction: column; text-align: center; }
    #school-logo { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; object-fit: cover; background: #fff; border: 3px solid var(--bg-color); }
    #school-name-display { font-size: 1.2rem; font-weight: 600; }
    #user-role-display { font-size: 0.9rem; color: #bdc3c7; }
    .sidebar nav { flex-grow: 1; overflow-y: auto; }
    .sidebar nav ul { list-style: none; width: 100%; padding: 15px 0; }
    .sidebar nav li a { display: flex; align-items: center; padding: 15px 30px; color: #ecf0f1; text-decoration: none; transition: all 0.3s ease; font-size: 1rem; border-left: 4px solid transparent; }
    .sidebar nav li a:hover, .sidebar nav li a.active { background-color: rgba(255, 255, 255, 0.05); border-left-color: var(--accent-color); color: #fff; }
    .sidebar nav li a i { margin-right: 15px; width: 20px; text-align: center; }
    #logout-btn { cursor: pointer; margin-top: auto; }
    .main-content { flex-grow: 1; margin-left: 260px; padding: 40px; transition: margin-left 0.3s ease-in-out; }
    .page { display: none; animation: fadeIn 0.5s ease-out; }
    .page.active { display: block; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; position: relative; }
    .form-wrapper, .table-wrapper { background: var(--card-bg); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 30px; }
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { background-color: #f8f9fa; font-weight: 600; }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ecf0f1; vertical-align: middle; }
    .profile-pic { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
    .action-buttons { display: flex; gap: 10px; align-items: center; }
    .action-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; transition: color 0.3s; }
    .edit-btn { color: var(--accent-color); }
    .delete-btn { color: var(--danger-color); }
    .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; }
    .hamburger-menu { display: none; font-size: 1.8rem; background: none; border: none; color: var(--primary-color); cursor: pointer; position: absolute; right: 30px; top: 35px; z-index: 1001; }
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: var(--border-radius); animation: fadeIn 0.4s; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .modal-header h2 { margin: 0; }
    .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .modal-body { padding: 20px 0; max-height: 70vh; overflow-y: auto;}
    .attendance-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
    .attendance-status { display: flex; gap: 10px; }
    .attendance-status label { cursor: pointer; padding: 5px 12px; border: 1px solid #ccc; border-radius: 20px; transition: all 0.2s; font-size: 0.9rem; }
    .attendance-status input[type="radio"] { display: none; }
    .attendance-status input[type="radio"]:checked + label { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    .schedule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .day-column { background: #fff; padding: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
    .day-column h3 { text-align: center; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 15px; }
    .schedule-card { background: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 5px solid var(--accent-color); position: relative; transition: box-shadow 0.3s; }
    .schedule-card:hover { box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
    .schedule-card p { margin: 3px 0; font-size: 0.95rem; }
    .schedule-actions { position: absolute; top: 5px; right: 5px; display: flex; opacity: 0; transition: opacity 0.3s; }
    .schedule-card:hover .schedule-actions { opacity: 1; }
    .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-link { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 1rem; font-weight: 600; color: var(--text-color); border-bottom: 3px solid transparent; transition: all 0.3s; }
    .tab-link.active { border-bottom: 3px solid var(--primary-color); color: var(--primary-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.5s; }
    .premium-icon { color: var(--premium-color); margin-left: 8px; }
    
    @media (max-width: 992px) {
        .sidebar { transform: translateX(-260px); }
        .sidebar.active { transform: translateX(0); }
        .main-content { margin-left: 0; }
        .hamburger-menu { display: block; }
    }
    @media (max-width: 576px) {
        .main-content { padding: 20px; }
        .form-wrapper, .table-wrapper { padding: 20px; }
        #login-box { padding: 25px; }
    }
</style><div id="login-container">
    <div id="login-box">
        <h2>Welcome to the SchoolSphere web </h2>
                <h3> make by nafiz iqbal  </h3>

        <form id="loginForm">
            <div class="input-group">
                <label for="loginRole">Your Role</label>
                <select id="loginRole" required>
                    <option value="admin">Administrator</option>
                    <option value="teacher">Teacher</option>
                    <option value="librarian">Librarian</option>
                </select>
            </div>
            <div class="input-group"><label for="loginEmail">Email</label><input type="email" id="loginEmail" required></div>
            <div class="input-group"><label for="loginPassword">Password</label><input type="password" id="loginPassword" required></div>
            <button type="submit" class="btn">Login</button>
        </form>
    </div>
        
</div>

<div id="app-wrapper">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img id="school-logo" src="https://i.ibb.co/6yT1WfX/school-logo-placeholder.png" alt="School Logo">
            <h2 id="school-name-display">School Name</h2>
            <span id="user-role-display">User</span>
        </div>
        <nav>
            <ul id="nav-list"></ul>
        </nav>
        <a id="logout-btn" class="nav-link" style="padding: 15px 30px;"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </aside>

    <main class="main-content">
        <header class="page-header">
            <h1 id="page-title">Dashboard</h1>
            <button class="hamburger-menu" id="hamburger-menu"><i class="fas fa-bars"></i></button>
        </header>
        
        <section id="admin-dashboard" class="page active"></section>
        <section id="teacher-dashboard" class="page"></section>
        <section id="add-student" class="page"></section>
        <section id="student-list" class="page"></section>
        <section id="teachers" class="page"></section>
        <section id="schedules" class="page"></section>
        <section id="settings" class="page"></section>
        <section id="student-attendance" class="page"></section>
        <section id="class-tests" class="page"></section>
        <section id="exam-management" class="page"></section> 
        <section id="student-profile" class="page"></section>
        <section id="library-management" class="page"></section>
        <section id="admission-management" class="page"></section>
    </main>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Edit Information</h2>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<!-- Hidden container for PDF generation -->
<div id="pdf-container" style="position: absolute; left: -9999px; width: 800px; padding: 20px; background: white; color: black;"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
    // IMPORTANT: Add your Firebase configuration here
    const firebaseConfig = {
      apiKey: "AIzaSyBtedt3DdNf3cX99-tOsqdnvMhDGFphNsI",
      authDomain: "schoolmanazmentbynfz.firebaseapp.com",
      databaseURL: "https://schoolmanazmentbynfz-default-rtdb.firebaseio.com",
      projectId: "schoolmanazmentbynfz",
      storageBucket: "schoolmanazmentbynfz.firebasestorage.app",
      messagingSenderId: "12002840470",
      appId: "1:12002840470:web:cfaaf4db50c030067017b7",
      measurementId: "G-TQEDT28GR2"
    };
    
    firebase.initializeApp(firebaseConfig);
    const secondaryApp = firebase.initializeApp(firebaseConfig, "secondary");
    const secondaryAuth = secondaryApp.auth();

    const db = firebase.database();
    const mainAuth = firebase.auth();
    
    let appState = { user: null, schoolId: null, settings: {}, students: {}, classes: {}, sections: {}, teachers: {}, librarians: {}, schedules: {}, leaves: {}, attendance: {}, exams: {}, marks: {}, mainExams: {}, rooms: {}, seatPlans: {}, invigilatorRosters: {}, library: {}, admissionApplications: {}, admissionSettings: {} };
    let attendanceChart = null; 

    document.addEventListener('DOMContentLoaded', () => {
        const loginForm = document.getElementById('loginForm');
        if (!loginForm) return;

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const role = document.getElementById('loginRole').value;
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginButton = e.target.querySelector('button[type="submit"]');
            loginButton.disabled = true; loginButton.textContent = 'Processing...';

            let schoolId = null; 

            mainAuth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    return db.ref('user_school_map/' + user.uid).once('value');
                })
                .then(snapshot => {
                    if (!snapshot.exists()) return Promise.reject(new Error("Your account is not associated with any school."));
                    schoolId = snapshot.val();
                    const rolePlural = role + 's';
                    return db.ref(`schools/${schoolId}/roles/${rolePlural}/${mainAuth.currentUser.uid}`).once('value');
                })
                .then(roleSnapshot => {
                    if (roleSnapshot.exists()) {
                        const user = mainAuth.currentUser;
                        const baseUser = { uid: user.uid, email: user.email, role: role };
                        
                        if (role === 'teacher' || role === 'librarian') {
                            const rolePath = role === 'teacher' ? 'teachers' : 'librarians';
                            return db.ref(`schools/${schoolId}/${rolePath}/${user.uid}`).once('value').then(userData => {
                                 appState.user = { ...baseUser, ...userData.val() };
                                 initializeApp(schoolId);
                            });
                        } else { 
                            appState.user = { ...baseUser, name: 'Administrator' };
                            initializeApp(schoolId);
                        }
                    } else {
                         let roleName = 'Administrator';
                         if(role === 'teacher') roleName = 'Teacher';
                         if(role === 'librarian') roleName = 'Librarian';
                        return Promise.reject(new Error(`You are not registered as a '${roleName}' for this school.`));
                    }
                })
                .catch(error => {
                    alert("Login Failed: " + error.message);
                    mainAuth.signOut();
                })
                .finally(() => {
                    loginButton.disabled = false; loginButton.textContent = 'Login';
                });
        });

        attachEventListeners();
    });

    function initializeApp(schoolId) {
        appState.schoolId = schoolId; 
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-wrapper').style.display = 'flex';
        document.getElementById('user-role-display').textContent = appState.user.name;
        fetchAllData();
    }
    
    function setupUI() {
        const userRole = appState.user.role;
        const navList = document.getElementById('nav-list');
        
        const allNavs = {
            'admin-dashboard': `<li><a href="#admin-dashboard" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>`,
            'teacher-dashboard': `<li><a href="#teacher-dashboard" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>`,
            'admission-management': `<li><a href="#admission-management" class="nav-link"><i class="fas fa-file-alt"></i> Admission Management</a></li>`,
            'add-student': `<li><a href="#add-student" class="nav-link"><i class="fas fa-user-plus"></i> Add Student</a></li>`,
            'student-list': `<li><a href="#student-list" class="nav-link"><i class="fas fa-users"></i> Student List</a></li>`,
            'teachers': `<li><a href="#teachers" class="nav-link"><i class="fas fa-chalkboard-user"></i> Staff Management</a></li>`,
            'schedules': `<li><a href="#schedules" class="nav-link"><i class="fas fa-calendar-alt"></i> Class Schedules</a></li>`,
            'student-attendance': `<li><a href="#student-attendance" class="nav-link"><i class="fas fa-user-check"></i> Student Attendance</a></li>`,
            'class-tests': `<li><a href="#class-tests" class="nav-link"><i class="fas fa-file-signature"></i> Class Tests & Scores</a></li>`,
            'exam-management': `<li><a href="#exam-management" class="nav-link"><i class="fas fa-sitemap"></i> Exam Management</a></li>`,
            'library-management': `<li><a href="#library-management" class="nav-link"><i class="fas fa-book-open-reader"></i> Library Management</a></li>`,
            'settings': `<li><a href="#settings" class="nav-link"><i class="fas fa-cogs"></i> Settings</a></li>`,
        };
        const adminNav = ['admin-dashboard', 'admission-management', 'add-student', 'student-list', 'teachers', 'schedules', 'exam-management', 'library-management', 'settings'];
        const teacherNav = ['teacher-dashboard', 'student-list', 'student-attendance', 'class-tests', 'schedules'];
        const librarianNav = ['library-management'];

        let navsToRender;
        if(userRole === 'admin') navsToRender = adminNav;
        else if (userRole === 'teacher') navsToRender = teacherNav;
        else if (userRole === 'librarian') navsToRender = librarianNav;
        
        navList.innerHTML = navsToRender.map(key => allNavs[key]).join('');

        const firstLink = document.querySelector('.nav-link');
        if (firstLink) {
            const initialPage = window.location.hash.substring(1) || firstLink.getAttribute('href').substring(1);
            navigateTo(initialPage);
        }
    }
    
    function fetchAllData() {
        const schoolId = appState.schoolId;
        if (!schoolId) return;
        
        db.ref(`schools/${schoolId}`).on('value', snapshot => {
            const schoolData = snapshot.val() || {};
            const defaultState = { user: appState.user, schoolId: appState.schoolId };
            appState = { ...defaultState, ...schoolData };

            setupUI();
            renderSchoolInfo();
            const hash = window.location.hash.substring(1) || (appState.user.role === 'admin' ? 'admin-dashboard' : appState.user.role === 'teacher' ? 'teacher-dashboard' : 'library-management');
            const [pageId, paramString] = hash.split('?');
            const params = paramString ? Object.fromEntries(new URLSearchParams(paramString)) : null;
            renderPageContent(pageId, params);
        });
    }

    function renderSchoolInfo(){
        const settings = appState.settings || {};
        document.getElementById('school-name-display').textContent = settings.schoolName || 'School Name';
        const logoEl = document.getElementById('school-logo');
        logoEl.src = settings.schoolLogoUrl || 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png';
        logoEl.onerror = () => { logoEl.src = 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'; };
    }
    
    function handleFormSubmits(e) {
        e.preventDefault();
        const form = e.target;
        const button = form.querySelector('button[type="submit"]');
        button.disabled = true; button.textContent = 'Processing...';
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const schoolId = appState.schoolId;

        const actions = {
            'addStudentForm': () => db.ref(`schools/${schoolId}/students`).push(data).then(() => { alert('Student added successfully!'); form.reset(); navigateTo('student-list'); }),
            'addStaffForm': () => {
                return secondaryAuth.createUserWithEmailAndPassword(data.email, data.password).then(cred => {
                    const staffUid = cred.user.uid;
                    const staffRole = data.role;
                    const rolePlural = staffRole + 's';
                    const staffData = {name: data.name, phone: data.phone, email: data.email, profilePicUrl: data.profilePicUrl};
                    if (staffRole === 'teacher') staffData.subject = data.subject;

                    const updates = {};
                    updates[`schools/${schoolId}/${rolePlural}/${staffUid}`] = staffData;
                    updates[`schools/${schoolId}/roles/${rolePlural}/${staffUid}`] = true;
                    updates[`user_school_map/${staffUid}`] = schoolId;
                    return db.ref().update(updates);
                }).then(() => { alert('Staff added successfully!'); form.reset(); secondaryAuth.signOut(); });
            },
            'addScheduleForm': () => db.ref(`schools/${schoolId}/schedules`).push(data).then(() => { alert('Schedule added successfully!'); form.reset(); }),
            'addClassForm': () => db.ref(`schools/${schoolId}/classes`).push({ name: document.getElementById('newClassName').value.trim() }).then(() => form.reset()),
            'addSectionForm': () => db.ref(`schools/${schoolId}/sections`).push({ name: document.getElementById('newSectionName').value.trim() }).then(() => form.reset()),
            'addAdmissionClassForm': () => db.ref(`schools/${schoolId}/admissionSettings/formClasses`).push({ name: document.getElementById('newAdmissionClassName').value.trim() }).then(() => form.reset()),
            'schoolSettingsForm': () => {
                const updates = {
                    'settings/schoolName': data.schoolName, 'settings/schoolLogoUrl': data.schoolLogoUrl,
                    'settings/principalName': data.principalName, 'settings/principalSignatureUrl': data.principalSignatureUrl
                };
                return db.ref(`schools/${schoolId}`).update(updates).then(() => alert('Settings saved successfully!'));
            },
            'editForm': () => {
                const path = form.dataset.type === 'admissionApplication' ? 
                             `admissionApplications/${form.dataset.id}` : 
                             `${form.dataset.type}s/${form.dataset.id}`;
                return db.ref(`schools/${schoolId}/${path}`).update(data).then(() => { 
                    alert('Information updated!'); 
                    closeModal(); 
                });
            },
            'addExamForm': () => { data.createdBy = appState.user.uid; return db.ref(`schools/${schoolId}/exams`).push(data).then(() => { alert('Class test created successfully!'); form.reset(); }); },
            'attendanceForm': () => {
                const date = document.getElementById('attendanceDate').value;
                const classSection = document.getElementById('attendanceClassSelector').value;
                const updates = {};
                for(const [key, value] of formData.entries()){
                    const studentId = key.replace('status_', '');
                    updates[`/schools/${schoolId}/attendance/${date}/${classSection}/${studentId}`] = { status: value };
                }
                return db.ref().update(updates).then(() => alert('Attendance saved!'));
            },
            'markEntryForm': () => {
                const examId = form.dataset.examId;
                const updates = {};
                for(const [key, value] of formData.entries()){
                     if (value.trim() !== '') updates[`/schools/${schoolId}/marks/${examId}/${key}`] = { marksObtained: parseFloat(value) };
                }
                return db.ref().update(updates).then(() => { alert('Marks saved successfully!'); closeModal(); });
            },
            'addMainExamForm': () => db.ref(`schools/${schoolId}/mainExams`).push(data).then(() => { alert('Main exam added successfully!'); form.reset(); }),
            'addRoomForm': () => db.ref(`schools/${schoolId}/rooms`).push(data).then(() => { alert('Room added successfully!'); form.reset(); }),
            'examRoutineForm': () => {
                const examId = form.dataset.examId;
                const updates = {};
                for (const [key, value] of formData.entries()) {
                    if (value) {
                        updates[`/schools/${appState.schoolId}/mainExams/${examId}/routine/${key}`] = value;
                    }
                }
                return db.ref().update(updates).then(() => { alert('Routine saved!'); closeModal(); });
            },
            'addBookForm': () => { 
                data.availableQuantity = parseInt(data.totalQuantity);
                return db.ref(`schools/${schoolId}/library/books`).push(data).then(() => { alert('Book added successfully!'); form.reset(); }); 
            },
            'issueBookForm': () => {
                const bookId = data.bookId;
                const studentId = data.studentId;
                const book = appState.library.books[bookId];

                if (!book || book.availableQuantity < 1) {
                    return Promise.reject(new Error("This book is currently unavailable."));
                }
                
                const issueData = {
                    bookId: bookId,
                    studentId: studentId,
                    issueDate: new Date().toISOString().slice(0, 10),
                    dueDate: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10),
                    returnDate: null,
                    status: 'issued'
                };
                const updates = {};
                updates[`schools/${schoolId}/library/books/${bookId}/availableQuantity`] = book.availableQuantity - 1;
                updates[`schools/${schoolId}/library/issuedBooks/${db.ref().push().key}`] = issueData;

                return db.ref().update(updates).then(() => { alert('Book issued successfully!'); form.reset(); });
            }
        };
        const action = actions[form.id];
        if (action) {
            action().catch(err => alert("Error: " + err.message))
                  .finally(() => { 
                      button.disabled = false; 
                      const originalText = form.id.includes('add') ? 'Add' : 'Save';
                      button.textContent = originalText;
                  });
        } else { button.disabled = false; }
    }
    
    function deleteItem(id, path) { if (confirm('Are you sure you want to delete this item?')) { db.ref(`schools/${appState.schoolId}/${path}/${id}`).remove().catch(err => alert(err.message)); } }
    function deleteStaff(uid, role) {
        if (confirm(`Are you sure you want to delete this ${role}? This action is irreversible and will disable their login.`)) {
             alert("This action is restricted. Please contact the super administrator. (Demo limitation)");
        }
    }
    
    function navigateTo(pageId, params = null) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if(targetPage) {
            targetPage.classList.add('active');
            const paramString = params ? `?${new URLSearchParams(params).toString()}` : '';
            history.pushState(null, '', '#' + pageId + paramString);
        }
        
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        const activeLink = document.querySelector(`.nav-link[href="#${pageId}"]`);
        if(activeLink) {
            activeLink.classList.add('active');
            document.getElementById('page-title').textContent = activeLink.textContent.trim();
        } else {
             document.getElementById('page-title').textContent = "Details";
        }

        renderPageContent(pageId, params);
        document.getElementById('sidebar').classList.remove('active');
    }
    window.onpopstate = () => {
        const defaultPage = appState.user.role === 'admin' ? 'admin-dashboard' : appState.user.role === 'teacher' ? 'teacher-dashboard' : 'library-management';
        const hash = window.location.hash.substring(1) || defaultPage;
        const [pageId, paramString] = hash.split('?');
        const params = paramString ? Object.fromEntries(new URLSearchParams(paramString)) : null;
        navigateTo(pageId, params);
    };
    
    function renderPageContent(pageId, params = null) {
        const pageElement = document.getElementById(pageId); if (!pageElement) return;
        const pageRenderers = {'admin-dashboard': getAdminDashboardHTML, 'teacher-dashboard': getTeacherDashboardHTML, 'add-student': getAddStudentHTML, 'student-list': getStudentListHTML, 'teachers': getTeachersHTML, 'schedules': getSchedulesHTML, 'settings': getSettingsHTML, 'student-attendance': getAttendanceHTML, 'class-tests': getClassTestsHTML, 'student-profile': getStudentProfileHTML, 'exam-management': getExamManagementHTML, 'library-management': getLibraryManagementHTML, 'admission-management': getAdmissionManagementHTML};
        if(pageRenderers[pageId]) pageElement.innerHTML = pageRenderers[pageId](params);
        const pagePopulators = {'admin-dashboard': populateAdminDashboard, 'teacher-dashboard': populateTeacherDashboard, 'student-list': populateStudentTable, 'add-student': populateAllDropdowns, 'teachers': populateTeachersTable, 'schedules': () => { populateAllDropdowns(); populateScheduleGrid(); }, 'settings': populateSettingsPage, 'student-attendance': populateAttendancePage, 'class-tests': populateClassTestsPage, 'student-profile': populateStudentProfilePage, 'exam-management': populateExamManagementPage, 'library-management': populateLibraryManagementPage, 'admission-management': populateAdmissionManagementPage};
        if(pagePopulators[pageId]) pagePopulators[pageId](params);
    }
    
    // HTML Generator Functions
    function getAdminDashboardHTML() { return `<div class="grid-container"> <div class="form-wrapper"><h3><i class="fas fa-users"></i> Total Students</h3><h2 id="total-students">0</h2></div> <div class="form-wrapper"><h3><i class="fas fa-chalkboard-user"></i> Total Staff</h3><h2 id="total-teachers">0</h2></div> <div class="form-wrapper"><h3><i class="fas fa-layer-group"></i> Total Classes</h3><h2 id="total-classes">0</h2></div> <div class="form-wrapper"><h3><i class="fas fa-book"></i> Books in Library</h3><h2 id="total-books">0</h2></div></div> <div class="form-wrapper" style="height: 400px;"> <h2>Today's Attendance Rate by Class</h2> <canvas id="attendanceChart"></canvas> </div>`; }
    function getSchedulesHTML() { const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"]; const adminForm = appState.user.role === 'admin' ? `<div class="form-wrapper"> <h2>Create New Class Schedule</h2> <form id="addScheduleForm"> <div class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"> <div class="input-group"><label>Day</label><select name="day" required>${days.map((day, i) => `<option value="${i}">${day}</option>`).join('')}</select></div> <div class="input-group"><label>Class</label><select name="className" id="scheduleClass" required></select></div> <div class="input-group"><label>Section</label><select name="section" id="scheduleSection" required></select></div> <div class="input-group"><label>Subject</label><input name="subject" required></div> <div class="input-group"><label>Teacher</label><select name="teacherId" id="scheduleTeacher" required></select></div> <div class="input-group"><label>Start Time</label><input type="time" name="startTime" required></div> <div class="input-group"><label>End Time</label><input type="time" name="endTime" required></div> </div> <button type="submit" class="btn">Add Schedule</button> </form> </div>` : ''; return `${adminForm} <div> <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;"> <h2 style="color: var(--text-color);">Weekly Class Routine</h2> <div style="display:flex; gap: 10px; align-items: center;"> <select id="routineFilter" onchange="populateScheduleGrid()" style="padding: 10px; border-radius: 8px; border: 1px solid #ccc;"><option value="all">All Classes</option></select> <button class="btn" onclick="generateWordStyleRoutinePdf()" style="width:auto; margin-top:0; background-color: var(--accent-color);"><i class="fas fa-file-pdf"></i> Download PDF</button></div> </div> <div id="schedule-display" class="schedule-grid"> ${days.map((day, i) => `<div class="day-column"><h3>${day}</h3><div id="day-${i}"></div></div>`).join('')} </div> </div>`; }
    function getAttendanceHTML() { return ` <div class="form-wrapper"> <h2>Take Student Attendance</h2> <div class="grid-container" style="grid-template-columns: 1fr 1fr auto; align-items:flex-end;"> <div class="input-group"> <label>Class & Section</label> <select id="attendanceClassSelector"></select> </div> <div class="input-group"> <label>Date</label> <input type="date" id="attendanceDate" value="${new Date().toISOString().slice(0,10)}"> </div> <div id="attendance-actions" style="margin-bottom: 15px; display:none;"><button class="btn" style="width:auto; background-color: var(--success-color);" onclick="generateAttendanceReportPdf()"><i class="fas fa-file-pdf"></i> Monthly Report</button></div> </div> </div> <div class="table-wrapper"> <form id="attendanceForm"> <div id="attendanceStudentList"> <p>Please select a class and date to view students.</p> </div> <button type="submit" class="btn" id="saveAttendanceBtn" style="display:none;">Save Attendance</button> </form> </div>`; }
    function getClassTestsHTML() { return ` <div class="form-wrapper"> <h2>Create New Class Test</h2> <form id="addExamForm"> <div class="grid-container"> <div class="input-group"><label>Test Name</label><input type="text" name="examName" required></div> <div class="input-group"><label>Class</label><select name="className" id="examClass" required></select></div> <div class="input-group"><label>Section</label><select name="section" id="examSection" required></select></div> <div class="input-group"><label>Subject</label><input type="text" name="subject" required></div> <div class="input-group"><label>Total Marks</label><input type="number" name="totalMarks" required></div> </div> <button type="submit" class="btn">Create Test</button> </form> </div> <div class="table-wrapper"> <h2>My Created Tests</h2> <table id="examsTable"> <thead><tr><th>Name</th><th>Class</th><th>Subject</th><th>Total Marks</th><th>Action</th></tr></thead> <tbody></tbody> </table> </div>`; }
    function getExamManagementHTML() { return ` <div class="tabs"> <button class="tab-link active" onclick="openTab(event, 'main-exam')">Main Exams & Routine</button> <button class="tab-link" onclick="openTab(event, 'room-management')">Room Management</button> <button class="tab-link" onclick="openTab(event, 'seat-plan')">Seat Plan</button> <button class="tab-link" onclick="openTab(event, 'invigilator-duty')">Invigilator Duty</button> </div> <div id="main-exam" class="tab-content active"> <div class="form-wrapper"> <h2>Create New Main Exam</h2> <form id="addMainExamForm"> <div class="grid-container"> <div class="input-group"><label>Exam Name (e.g., Half-Yearly Exam 2025)</label><input type="text" name="name" required></div> <div class="input-group"><label>Exam Start Date</label><input type="date" name="date" required></div> </div> <button type="submit" class="btn">Create Exam</button> </form> </div> <div class="table-wrapper"> <h2>List of Main Exams</h2> <div id="mainExamsList" class="table-responsive"></div> </div> </div> <div id="room-management" class="tab-content"> <div class="form-wrapper"> <h2>Add New Room</h2> <form id="addRoomForm" class="grid-container" style="grid-template-columns: 2fr 1fr auto; align-items: end;"> <div class="input-group"><label>Room Name/Number</label><input type="text" name="name" required></div> <div class="input-group"><label>Capacity</label><input type="number" name="capacity" required></div> <button type="submit" class="btn" style="width:auto; height: 48px; margin-bottom: 15px;">Add</button> </form> </div> <div class="table-wrapper"><h2>Room List</h2><div id="roomsList" class="table-responsive"></div></div> </div> <div id="seat-plan" class="tab-content"> <div class="form-wrapper"> <h2>Generate Seat Plan</h2> <div class="grid-container"> <div class="input-group"><label>Select Exam</label><select id="seatPlanExamSelect" onchange="generateSeatPlan()"></select></div> <div class="input-group"><label>Select Class</label><select id="seatPlanClassSelect" onchange="generateSeatPlan()"></select></div> </div> <div class="input-group"><label>Select Rooms (Hold Ctrl/Cmd to select multiple)</label><select id="seatPlanRoomSelect" multiple style="height: 150px;" onchange="generateSeatPlan()"></select></div> </div> <div class="table-wrapper"> <div style="display:flex; justify-content:space-between; align-items:center;"> <h2>Generated Seat Plan</h2> <button class="btn" onclick="generatePdf('#seatPlanDisplay', 'Seat-Plan')" id="downloadSeatPlanBtn" style="width:auto; background-color: var(--success-color);"><i class="fas fa-file-pdf"></i> Download PDF</button> </div> <div id="seatPlanDisplay" style="margin-top:20px;">Please fill the form above to generate a plan.</div> </div> </div> <div id="invigilator-duty" class="tab-content"> <div class="form-wrapper"> <h2>Create Invigilator Duty Roster</h2> <div class="grid-container"> <div class="input-group"><label>Select Exam</label><select id="rosterExamSelect" onchange="renderRosterUI()"></select></div> <div class="input-group"><label>Date</label><input type="date" id="rosterDate" required onchange="renderRosterUI()"></div> </div> <div id="rosterRoomTeacherSelection"></div> <button class="btn" onclick="saveInvigilatorRoster()">Save Roster</button> </div> <div class="table-wrapper"> <div style="display:flex; justify-content:space-between; align-items:center;"> <h2>Duty Roster</h2> <button class="btn" onclick="generatePdf('#rosterDisplay', 'Duty-Roster')" id="downloadRosterBtn" style="width:auto; background-color: var(--success-color);"><i class="fas fa-file-pdf"></i> Download PDF</button> </div> <div id="rosterDisplay" style="margin-top:20px;">Please select an exam and date.</div> </div> </div>`; }
    function getStudentProfileHTML(params) { if (!params || !params.id) return `<p>Student not found.</p>`; return `<div class="grid-container" style="grid-template-columns: 1fr 2fr;"> <div class="form-wrapper" id="profile-details">Loading...</div> <div class="form-wrapper"> <div style="display:flex; justify-content:space-between; align-items:center;"><h2>Academic Records</h2> <button class="btn" style="width:auto; margin-top:0;" onclick="generateReportCardPdf('${params.id}')"><i class="fas fa-file-pdf"></i> Download Report Card</button></div> <div id="profile-exam-results" class="table-responsive" style="margin-top:20px;"></div></div></div><div class="form-wrapper"><h3>Library History</h3><div id="profile-library-books" class="table-responsive"></div></div>`; }
    function getAddStudentHTML() {  return `<div class="form-wrapper"> <h2>Add New Student</h2> <form id="addStudentForm"> <div class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"> <div class="input-group"><label>Student Name</label><input type="text" name="name" required></div> <div class="input-group"><label>Roll Number</label><input type="number" name="roll" required></div> <div class="input-group"><label>Class</label><select name="className" id="studentClass" required></select></div> <div class="input-group"><label>Section</label><select name="section" id="studentSection" required></select></div> <div class="input-group"><label>Guardian's Name</label><input type="text" name="guardianName" required></div> <div class="input-group"><label>Contact Number</label><input type="text" name="contact" required></div> <div class="input-group" style="grid-column: 1 / -1;"><label>Profile Picture URL</label><input type="url" name="profilePicUrl" placeholder="https://example.com/image.jpg"></div> </div> <button type="submit" class="btn">Add Student</button> </form> </div>`; }
    function getStudentListHTML() { return `<div class="table-wrapper"><div class="table-responsive"><table> <thead><tr><th>Photo</th><th>Name</th><th>Class</th><th>Roll</th><th>Actions</th></tr></thead> <tbody id="allStudentsTableBody"></tbody> </table></div></div>`; }
    function getTeachersHTML() { return `<div class="form-wrapper"> <h2>Add New Staff</h2> <form id="addStaffForm"> <div class="grid-container"> <div class="input-group"><label>Name</label><input type="text" name="name" required></div> <div class="input-group"><label>Role</label><select name="role" id="staffRole" required onchange="toggleSubjectField()"><option value="teacher">Teacher</option><option value="librarian">Librarian</option></select></div> <div class="input-group" id="subject-input-group"><label>Subject</label><input type="text" name="subject"></div> <div class="input-group"><label>Phone</label><input type="text" name="phone"></div> <div class="input-group"><label>Profile Picture URL</label><input type="url" name="profilePicUrl"></div> <div class="input-group"><label>Email (for login)</label><input type="email" name="email" required></div> <div class="input-group"><label>Password</label><input type="password" name="password" minlength="6" required></div> </div> <button type="submit" class="btn">Add Staff</button> </form> </div> <div class="table-wrapper"><h2>Staff List</h2><div class="table-responsive"><table id="teachersTable"></table></div></div>`; }
    function getSettingsHTML() { return ` <div class="form-wrapper"> <h2>School Information & PDF Settings</h2> <form id="schoolSettingsForm"> <div class="input-group"><label for="schoolName">School Name</label><input type="text" name="schoolName" id="schoolName" required></div> <div class="input-group"><label for="schoolLogoUrl">School Logo URL</label><input type="url" name="schoolLogoUrl" id="schoolLogoUrl" placeholder="https://example.com/logo.png"></div> <div class="input-group"><label for="principalName">Principal's Name (for signature)</label><input type="text" name="principalName" id="principalName"></div> <div class="input-group"><label for="principalSignatureUrl">Principal's Signature Image URL</label><input type="url" name="principalSignatureUrl" id="principalSignatureUrl" placeholder="https://example.com/signature.png"></div> <button type="submit" class="btn">Save Settings</button> </form> </div> <div class="grid-container"> <div class="form-wrapper"><h3>Class Management</h3><form id="addClassForm" style="display:flex; gap:10px;"><input type="text" id="newClassName" placeholder="Class Name" required style="flex-grow:1;"><button class="btn" type="submit" style="width:auto; margin-top:0;">Add</button></form><ul id="classList" style="list-style-type: none; padding-top: 10px;"></ul></div> <div class="form-wrapper"><h3>Section Management</h3><form id="addSectionForm" style="display:flex; gap:10px;"><input type="text" id="newSectionName" placeholder="Section Name" required style="flex-grow:1;"><button class="btn" type="submit" style="width:auto; margin-top:0;">Add</button></form><ul id="sectionList" style="list-style-type: none; padding-top: 10px;"></ul></div> </div>`; }
    function getTeacherDashboardHTML() { return `<div class="grid-container" style="grid-template-columns: 2fr 1fr;"> <div> <div class="form-wrapper"> <h2>Today's Classes</h2> <div id="todaysClassesList" class="grid-container"><p>Loading...</p></div> </div> <div class="form-wrapper"> <h2>My Weekly Routine</h2><div id="my-weekly-schedule" class="schedule-grid"></div> </div> </div> <div> <div class="form-wrapper"> <h2>Upcoming Duties</h2> <div id="my-duties">Loading...</div> </div> </div> </div>`; }
    function getLibraryManagementHTML() { return `<div class="tabs"> <button class="tab-link active" onclick="openTab(event, 'manage-books')">Book Management</button> <button class="tab-link" onclick="openTab(event, 'issue-return')">Issue & Return Books</button> </div> <div id="manage-books" class="tab-content active"> <div class="form-wrapper"> <h2>Add New Book</h2> <form id="addBookForm"> <div class="grid-container"> <div class="input-group"><label>Book Title</label><input type="text" name="title" required></div> <div class="input-group"><label>Author Name</label><input type="text" name="author" required></div> <div class="input-group"><label>ISBN</label><input type="text" name="isbn"></div> <div class="input-group"><label>Total Quantity</label><input type="number" name="totalQuantity" required></div> </div> <button type="submit" class="btn">Add Book</button> </form> </div> <div class="table-wrapper"><h2>All Library Books</h2><div id="allBooksTable" class="table-responsive"></div></div> </div> <div id="issue-return" class="tab-content"> <div class="form-wrapper"> <h2>Issue Book to Student</h2> <form id="issueBookForm"> <div class="grid-container"> <div class="input-group"><label>Select Book</label><select name="bookId" id="issueBookId" required></select></div> <div class="input-group"><label>Select Student</label><select name="studentId" id="issueStudentId" required></select></div> </div> <button type="submit" class="btn">Issue Book</button> </form> </div> <div class="table-wrapper"><h2>Issued Books List</h2><div id="issuedBooksTable" class="table-responsive"></div></div> </div>`;}
    function getAdmissionManagementHTML() { return ` <div class="tabs"> <button class="tab-link active" onclick="openTab(event, 'applications')">Applications</button> <button class="tab-link" onclick="openTab(event, 'form-settings')">Form Settings</button> </div> <div id="applications" class="tab-content active"> <div class="table-wrapper"> <h2>Pending Admission Applications</h2> <div class="table-responsive"> <table id="applicationsTable"> <thead><tr><th>Applicant Name</th><th>Applying for Class</th><th>Guardian's Contact</th><th>Actions</th></tr></thead> <tbody></tbody> </table> </div> </div> </div> <div id="form-settings" class="tab-content"> <div class="form-wrapper"> <h3>Manage Classes for Admission Form</h3> <p>Add or remove classes that will be shown as options in the public admission form.</p> <form id="addAdmissionClassForm" style="display:flex; gap:10px; margin-top: 15px;"> <input type="text" id="newAdmissionClassName" placeholder="Class Name" required style="flex-grow:1;"> <button class="btn" type="submit" style="width:auto; margin-top:0;">Add Class</button> </form> <ul id="admissionClassList" style="list-style-type: none; padding-top: 10px;"></ul> </div> </div>`;}

    // Data Populator Functions
    function populateAdminDashboard(){ 
        document.getElementById('total-students').textContent = Object.keys(appState.students || {}).length; 
        const totalTeachers = Object.keys(appState.teachers || {}).length;
        const totalLibrarians = Object.keys(appState.librarians || {}).length;
        document.getElementById('total-teachers').textContent = totalTeachers + totalLibrarians;
        document.getElementById('total-classes').textContent = Object.keys(appState.classes || {}).length; 
        document.getElementById('total-books').textContent = Object.keys(appState.library?.books || {}).length; 

        const ctx = document.getElementById('attendanceChart').getContext('2d'); const attendance = appState.attendance || {}; const today = new Date().toISOString().slice(0,10); const todaysAttendance = attendance[today] || {}; const classData = {}; const allStudents = appState.students || {}; const totalStudentsByClass = {}; for(const student of Object.values(allStudents)) { const key = `${student.className}___${student.section}`; totalStudentsByClass[key] = (totalStudentsByClass[key] || 0) + 1; } Object.entries(todaysAttendance).forEach(([classSection, students]) => { let presentCount = 0; Object.values(students).forEach(att => { if(att.status === 'present') presentCount++; }); classData[classSection] = { present: presentCount, total: totalStudentsByClass[classSection] || Object.keys(students).length }; }); const labels = Object.keys(classData).map(c => c.replace('___', ' - ')); const percentages = Object.values(classData).map(data => data.total > 0 ? (data.present / data.total) * 100 : 0); if(attendanceChart) { attendanceChart.destroy(); } attendanceChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Attendance Rate (%)', data: percentages, backgroundColor: 'rgba(74, 105, 189, 0.6)', borderColor: 'rgba(74, 105, 189, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, max: 100 } }, responsive: true, maintainAspectRatio: false } }); 
    }
    function populateScheduleGrid() { const container = document.getElementById('schedule-display'); if(!container) return; const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"]; container.innerHTML = days.map((day, i) => `<div class="day-column"><h3>${day}</h3><div id="day-${i}"></div></div>`).join(''); const filter = document.getElementById('routineFilter'); const classes = [...new Set(Object.values(appState.schedules || {}).map(s => `${s.className}___${s.section}`))]; const currentFilterValue = filter.value; filter.innerHTML = '<option value="all">All Classes</option>' + classes.sort().map(c => { const [className, section] = c.split('___'); return `<option value="${c}">${className} (${section})</option>`; }).join(''); filter.value = currentFilterValue; let schedulesToDisplay = Object.entries(appState.schedules || {}); if (filter.value !== 'all') { const [className, section] = filter.value.split('___'); schedulesToDisplay = schedulesToDisplay.filter(([,s]) => s.className === className && s.section === section); } schedulesToDisplay.forEach(([id, s]) => { const dayContainer = document.getElementById(`day-${s.day}`); if (dayContainer) { const teacherName = appState.teachers[s.teacherId]?.name || 'Unknown'; dayContainer.innerHTML += `<div class="schedule-card"> ${appState.user.role === 'admin' ? `<div class="schedule-actions"> <button class="action-btn edit-btn" onclick="openEditModal('schedule', '${id}')"><i class="fas fa-edit"></i></button> <button class="action-btn delete-btn" onclick="deleteItem('${id}', 'schedules')"><i class="fas fa-trash"></i></button> </div>` : ''} <p><strong>${s.className} (${s.section})</strong></p> <p>Subject: ${s.subject}</p><p>Teacher: ${teacherName}</p><p>Time: ${s.startTime} - ${s.endTime}</p> </div>`; } }); }
    function populateAllDropdowns() { populateDropdown(appState.classes, 'studentClass'); populateDropdown(appState.sections, 'studentSection'); populateDropdown(appState.classes, 'scheduleClass'); populateDropdown(appState.sections, 'scheduleSection'); populateDropdownWithKeys(appState.teachers, 'scheduleTeacher', item => `${item.name} (${item.subject})`); }
    function populateStudentTable() { const tbody = document.getElementById('allStudentsTableBody'); tbody.innerHTML = ''; Object.entries(appState.students || {}).sort(([,a],[,b])=> a.roll-b.roll).sort(([,a],[,b])=>a.className.localeCompare(b.className)).forEach(([id, s]) => { tbody.innerHTML += `<tr> <td><img src="${s.profilePicUrl || 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'}" class="profile-pic" onerror="this.src='https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'"></td> <td>${s.name}</td><td>${s.className} (${s.section})</td><td>${s.roll}</td> <td><div class="action-buttons"> <button class="btn" data-id="${id}" style="padding: 5px 10px; font-size: 0.9rem; margin:0;" onclick="navigateTo('student-profile', { id: '${id}' })">View Profile</button> ${appState.user.role === 'admin' ? `<button class="action-btn edit-btn" onclick="openEditModal('student', '${id}')"><i class="fas fa-edit"></i></button> <button class="action-btn delete-btn" onclick="deleteItem('${id}', 'students')"><i class="fas fa-trash"></i></button>` : ''} </div></td> </tr>`; }); }
    function populateTeachersTable() { const table = document.getElementById('teachersTable'); table.innerHTML = '<thead><tr><th>Photo</th><th>Name</th><th>Role</th><th>Subject/Responsibility</th><th>Email</th><th>Action</th></tr></thead><tbody></tbody>'; const tbody = table.querySelector('tbody'); Object.entries(appState.teachers || {}).forEach(([uid, t]) => { tbody.innerHTML += `<tr> <td><img src="${t.profilePicUrl || 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'}" class="profile-pic" onerror="this.src='https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'"></td> <td>${t.name}</td><td>Teacher</td><td>${t.subject}</td><td>${t.email}</td> <td><div class="action-buttons"> <button class="action-btn edit-btn" onclick="openEditModal('teacher', '${uid}')"><i class="fas fa-edit"></i></button> <button class="action-btn delete-btn" onclick="deleteStaff('${uid}', 'teacher')"><i class="fas fa-trash"></i></button> </div></td> </tr>`; }); Object.entries(appState.librarians || {}).forEach(([uid, l]) => { tbody.innerHTML += `<tr> <td><img src="${l.profilePicUrl || 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'}" class="profile-pic" onerror="this.src='https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'"></td> <td>${l.name}</td><td>Librarian</td><td>Library Management</td><td>${l.email}</td> <td><div class="action-buttons"> <button class="action-btn edit-btn" onclick="openEditModal('librarian', '${uid}')"><i class="fas fa-edit"></i></button> <button class="action-btn delete-btn" onclick="deleteStaff('${uid}', 'librarian')"><i class="fas fa-trash"></i></button> </div></td> </tr>`; });}
    function toggleSubjectField(){ const role = document.getElementById('staffRole').value; document.getElementById('subject-input-group').style.display = (role === 'teacher') ? 'flex' : 'none';}
    function populateSettingsPage() { populateList(appState.classes, 'classList', 'classes'); populateList(appState.sections, 'sectionList', 'sections'); const settings = appState.settings || {}; document.getElementById('schoolName').value = settings.schoolName || ''; document.getElementById('schoolLogoUrl').value = settings.schoolLogoUrl || ''; document.getElementById('principalName').value = settings.principalName || ''; document.getElementById('principalSignatureUrl').value = settings.principalSignatureUrl || ''; }
    function populateTeacherDashboard() { const container = document.getElementById('todaysClassesList'); if(!container) return; const dayMap = [1, 2, 3, 4, 5, -1, 0]; const formDayIndex = dayMap[new Date().getDay()]; const todaysSchedules = Object.values(appState.schedules || {}).filter(s => s.teacherId === appState.user.uid && parseInt(s.day) === formDayIndex).sort((a, b) => a.startTime.localeCompare(b.startTime)); container.innerHTML = (todaysSchedules.length === 0) ? `<p>You have no classes today.</p>` : todaysSchedules.map(s => ` <div class="schedule-card"> <h4>${s.className} (${s.section})</h4><p><strong>Subject:</strong> ${s.subject}</p><p><strong>Time:</strong> ${s.startTime} - ${s.endTime}</p> </div>`).join(''); populateMyWeeklySchedule(); populateMyDuties(); }
    function populateMyDuties() { const dutyContainer = document.getElementById('my-duties'); if (!dutyContainer) return; const myId = appState.user.uid; let dutiesHtml = ''; Object.entries(appState.invigilatorRosters || {}).forEach(([examId, dates]) => { const exam = appState.mainExams[examId]; Object.entries(dates).forEach(([date, rooms]) => { Object.entries(rooms).forEach(([roomId, teacherId]) => { if (teacherId === myId) { const room = appState.rooms[roomId]; dutiesHtml += `<div class="schedule-card"><p><strong>${exam.name}</strong></p><p><strong>Date:</strong> ${date}</p><p><strong>Room:</strong> ${room.name}</p></div>`; } }); }); }); dutyContainer.innerHTML = dutiesHtml || '<p>You have no upcoming duties.</p>'; }
    function populateMyWeeklySchedule() { const container = document.getElementById('my-weekly-schedule'); if (!container) return; const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"]; container.innerHTML = days.map((day, i) => `<div class="day-column"><h3>${day}</h3><div id="my-day-${i}"></div></div>`).join(''); Object.values(appState.schedules || {}).filter(s => s.teacherId === appState.user.uid).forEach(s => { const dayContainer = document.getElementById(`my-day-${s.day}`); if (dayContainer) { dayContainer.innerHTML += `<div class="schedule-card"><p><strong>${s.className} (${s.section})</strong></p><p>Subject: ${s.subject}</p><p>Time: ${s.startTime} - ${s.endTime}</p></div>`; } }); }
    function populateDropdown(data, selectId, isMultiple = false) { const select = document.getElementById(selectId); if (!select) return; if(!isMultiple) select.innerHTML = `<option value="">Select...</option>`; Object.values(data || {}).forEach(item => select.innerHTML += `<option value="${item.name}">${item.name}</option>`); }
    function populateDropdownWithKeys(data, selectId, displayFormatter, isMultiple = false) { const select = document.getElementById(selectId); if (!select) return; if(!isMultiple) select.innerHTML = `<option value="">Select...</option>`; Object.entries(data || {}).sort(([,a], [,b]) => a.name.localeCompare(b.name)).forEach(([id, item]) => { select.innerHTML += `<option value="${id}">${displayFormatter(item)}</option>`; }); }
    function populateList(data, listId, path) { const list = document.getElementById(listId); if (!list) return; list.innerHTML = ''; Object.entries(data || {}).forEach(([id, item]) => { list.innerHTML += `<li style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee;">${item.name} <button class="action-btn delete-btn" onclick="deleteItem('${id}', '${path}')"><i class="fas fa-trash"></i></button></li>`; }); }
    function openEditModal(type, id) {
        const modal = document.getElementById('editModal');
        const titleEl = document.getElementById('modalTitle');
        const bodyEl = document.getElementById('modalBody');
        const dataSources = { ...appState, 'admissionApplications': appState.admissionApplications || {} };
        const items = type === 'mainExam' ? appState.mainExams : dataSources[type + 's'] || dataSources[type];

        if (!items || !items[id]) {
            console.error("Item not found:", type, id);
            return;
        }
        
        const item = items[id];
        let formHTML = '';
        
        if (type === 'mainExam') {
            const exam = item;
            titleEl.textContent = `Create/Edit Routine for ${exam.name}`;
            let routineFieldsHTML = '';
            Object.entries(appState.classes || {}).sort(([,a], [,b]) => a.name.localeCompare(b.name)).forEach(([classKey, classItem]) => {
                const routineData = exam.routine || {};
                const subject = routineData[`${classKey}_subject`] || '';
                const date = routineData[`${classKey}_date`] || '';
                const time = routineData[`${classKey}_time`] || '';
                routineFieldsHTML += `
                    <div class="form-wrapper" style="padding: 20px; margin-bottom: 15px; border: 1px solid #eee;">
                        <h3 style="margin-bottom: 15px; color: var(--primary-color);">${classItem.name}</h3>
                        <div class="input-group"><label>Subject</label><input type="text" name="${classKey}_subject" value="${subject}"></div>
                        <div class="input-group"><label>Date</label><input type="date" name="${classKey}_date" value="${date}"></div>
                        <div class="input-group"><label>Time</label><input type="time" name="${classKey}_time" value="${time}"></div>
                    </div>
                `;
            });
            formHTML = `<form id="examRoutineForm" data-exam-id="${id}">${routineFieldsHTML}<button class="btn" type="submit">Save Routine</button></form>`;
            bodyEl.innerHTML = formHTML;
        } else {
             titleEl.textContent = `Edit ${type.charAt(0).toUpperCase() + type.slice(1)} Information`;
            if (type === 'student') { formHTML = ` <div class="input-group"><label>Name</label><input type="text" name="name" value="${item.name}" required></div> <div class="input-group"><label>Roll</label><input type="number" name="roll" value="${item.roll}" required></div> <div class="input-group"><label>Profile Picture URL</label><input type="url" name="profilePicUrl" value="${item.profilePicUrl || ''}"></div>`; } 
            else if (type === 'teacher' || type === 'librarian') { formHTML = ` <div class="input-group"><label>Name</label><input type="text" name="name" value="${item.name}" required></div> ${type === 'teacher' ? `<div class="input-group"><label>Subject</label><input type="text" name="subject" value="${item.subject}" required></div>` : ''} <div class="input-group"><label>Profile Picture URL</label><input type="url" name="profilePicUrl" value="${item.profilePicUrl || ''}"></div>`; } 
            else if (type === 'schedule') { const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"]; const dayOptions = days.map((d, i) => `<option value="${i}" ${item.day == i ? 'selected' : ''}>${d}</option>`).join(''); formHTML = `<div class="grid-container"> <div class="input-group"><label>Day</label><select name="day">${dayOptions}</select></div> <div class="input-group"><label>Subject</label><input type="text" name="subject" value="${item.subject}" required></div> <div class="input-group"><label>Start Time</label><input type="time" name="startTime" value="${item.startTime}" required></div> <div class="input-group"><label>End Time</label><input type="time" name="endTime" value="${item.endTime}" required></div> </div>`; }
            else if (type === 'admissionApplication') {
                formHTML = `
                    <div class="input-group"><label>Applicant Name</label><input type="text" name="studentName" value="${item.studentName || ''}" required></div>
                    <div class="input-group"><label>Guardian's Name</label><input type="text" name="guardianName" value="${item.guardianName || ''}" required></div>
                    <div class="input-group"><label>Guardian's Contact</label><input type="text" name="guardianContact" value="${item.guardianContact || ''}" required></div>
                    <div class="input-group"><label>Applying for Class</label><input type="text" name="className" value="${item.className || ''}" required></div>
                `;
            }
            bodyEl.innerHTML = `<form id="editForm" data-type="${type}" data-id="${id}">${formHTML}<button type="submit" class="btn">Update</button></form>`;
        }
        
        modal.style.display = "block";
    }
    function attachEventListeners() { document.body.addEventListener('click', e => { const navLink = e.target.closest('.nav-link'); if (navLink) { e.preventDefault(); if(navLink.id === 'logout-btn') { mainAuth.signOut().then(() => window.location.reload()); return; } navigateTo(navLink.getAttribute('href').substring(1)); } if (e.target.closest('.hamburger-menu')) document.getElementById('sidebar').classList.toggle('active'); }); document.body.addEventListener('submit', handleFormSubmits); }
    function closeModal() { document.getElementById('editModal').style.display = "none"; }
    window.onclick = (event) => { if (event.target == document.getElementById('editModal')) closeModal(); }
    
    function populateAttendancePage() {
        const selector = document.getElementById('attendanceClassSelector');
        if (!selector) return;
        selector.innerHTML = '<option value="">Select Class & Section...</option>';
        const classes = appState.classes || {};
        const sections = appState.sections || {};
        for (const classKey in classes) {
            for (const sectionKey in sections) {
                const classSectionValue = `${classes[classKey].name}___${sections[sectionKey].name}`;
                selector.innerHTML += `<option value="${classSectionValue}">${classes[classKey].name} - ${sections[sectionKey].name}</option>`;
            }
        }
        selector.onchange = loadStudentsForAttendance;
        document.getElementById('attendanceDate').onchange = loadStudentsForAttendance;
    }
    
    function loadStudentsForAttendance() {
        const classSection = document.getElementById('attendanceClassSelector').value;
        const date = document.getElementById('attendanceDate').value;
        const studentListDiv = document.getElementById('attendanceStudentList');
        const saveBtn = document.getElementById('saveAttendanceBtn');
        const actionsDiv = document.getElementById('attendance-actions');

        if (!classSection || !date) {
            studentListDiv.innerHTML = '<p>Please select a class and date to view students.</p>';
            saveBtn.style.display = 'none';
            actionsDiv.style.display = 'none';
            return;
        }

        actionsDiv.style.display = 'block';
        const [className, section] = classSection.split('___');
        const students = Object.entries(appState.students || {}).filter(([,s]) => s.className === className && s.section === section).sort(([,a],[,b])=> a.roll - b.roll);
        
        if (students.length === 0) {
            studentListDiv.innerHTML = '<p>No students found in this class.</p>';
            saveBtn.style.display = 'none';
            return;
        }

        let html = '';
        const todaysAttendance = appState.attendance?.[date]?.[classSection] || {};
        students.forEach(([id, student]) => {
            const status = todaysAttendance[id]?.status || 'present';
            html += `
                <div class="attendance-row">
                    <span>${student.roll}. ${student.name}</span>
                    <div class="attendance-status">
                        <input type="radio" id="present_${id}" name="status_${id}" value="present" ${status === 'present' ? 'checked' : ''}>
                        <label for="present_${id}">Present</label>
                        <input type="radio" id="absent_${id}" name="status_${id}" value="absent" ${status === 'absent' ? 'checked' : ''}>
                        <label for="absent_${id}">Absent</label>
                    </div>
                </div>
            `;
        });
        studentListDiv.innerHTML = html;
        saveBtn.style.display = 'block';
    }

    function populateClassTestsPage() {
        populateDropdown(appState.classes, 'examClass');
        populateDropdown(appState.sections, 'examSection');
        const tbody = document.querySelector('#examsTable tbody');
        tbody.innerHTML = '';
        const myExams = Object.entries(appState.exams || {}).filter(([,exam]) => exam.createdBy === appState.user.uid);
        if (myExams.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">You have not created any tests yet.</td></tr>';
            return;
        }
        myExams.forEach(([id, exam]) => {
            tbody.innerHTML += `
                <tr>
                    <td>${exam.examName}</td>
                    <td>${exam.className} (${exam.section})</td>
                    <td>${exam.subject}</td>
                    <td>${exam.totalMarks}</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 0.9rem; width: auto;" onclick="openMarkEntryModal('${id}')">Enter Marks</button>
                        <button class="action-btn delete-btn" onclick="deleteItem('${id}', 'exams')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    }
    
    function openMarkEntryModal(examId) {
        const exam = appState.exams[examId];
        const students = Object.entries(appState.students || {}).filter(([,s]) => s.className === exam.className && s.section === exam.section).sort(([,a],[,b]) => a.roll - b.roll);
        const marks = appState.marks?.[examId] || {};

        let formHTML = `<form id="markEntryForm" data-exam-id="${examId}">`;
        students.forEach(([id, student]) => {
            formHTML += `
                <div class="input-group" style="display: grid; grid-template-columns: 2fr 1fr; align-items: center;">
                    <label>${student.roll}. ${student.name}</label>
                    <input type="number" name="${id}" value="${marks[id]?.marksObtained || ''}" placeholder="Marks" max="${exam.totalMarks}" class="mark-input">
                </div>
            `;
        });
        formHTML += `<button type="submit" class="btn">Save Marks</button></form>`;
        document.getElementById('modalTitle').textContent = `Enter Marks for "${exam.examName}"`;
        document.getElementById('modalBody').innerHTML = formHTML;
        document.getElementById('editModal').style.display = 'block';
    }
    
    function populateStudentProfilePage(params) {
        if (!params || !params.id) return;
        const student = appState.students[params.id];
        if (!student) return;
        document.getElementById('profile-details').innerHTML = `
            <img src="${student.profilePicUrl || 'https://i.ibb.co/6yT1WfX/school-logo-placeholder.png'}" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; display: block; margin: 0 auto 20px; border: 4px solid var(--bg-color);">
            <h2 style="text-align: center; color: var(--primary-color);">${student.name}</h2>
            <p style="text-align:center; margin-top:10px;"><strong>Class:</strong> ${student.className} (${student.section})</p>
            <p style="text-align:center;"><strong>Roll:</strong> ${student.roll}</p>
            <p style="text-align:center;"><strong>Guardian:</strong> ${student.guardianName}</p>
            <p style="text-align:center;"><strong>Contact:</strong> ${student.contact}</p>
        `;
        
        const resultsDiv = document.getElementById('profile-exam-results');
        let tableHTML = '<table><thead><tr><th>Test Name</th><th>Subject</th><th>Marks Obtained</th><th>Total Marks</th></tr></thead><tbody>';
        let hasResults = false;
        Object.entries(appState.marks || {}).forEach(([examId, examMarks]) => {
            if(examMarks[params.id]){
                const exam = appState.exams[examId];
                if(exam) {
                    hasResults = true;
                    tableHTML += `
                        <tr>
                            <td>${exam.examName}</td>
                            <td>${exam.subject}</td>
                            <td>${examMarks[params.id].marksObtained}</td>
                            <td>${exam.totalMarks}</td>
                        </tr>
                    `;
                }
            }
        });
        if (!hasResults) tableHTML += '<tr><td colspan="4" style="text-align:center;">No test results found.</td></tr>';
        tableHTML += '</tbody></table>';
        resultsDiv.innerHTML = tableHTML;

        const libraryDiv = document.getElementById('profile-library-books');
        let libraryHTML = '<table><thead><tr><th>Book Title</th><th>Issue Date</th><th>Due Date</th></tr></thead><tbody>';
        const issuedBooks = Object.values(appState.library?.issuedBooks || {}).filter(issue => issue.studentId === params.id && issue.status === 'issued');
        if (issuedBooks.length > 0) {
            issuedBooks.forEach(issue => {
                const book = appState.library.books[issue.bookId];
                if(book) {
                    libraryHTML += `<tr><td>${book.title}</td><td>${issue.issueDate}</td><td>${issue.dueDate}</td></tr>`;
                }
            });
        } else {
            libraryHTML += '<tr><td colspan="3" style="text-align:center;">No books currently issued.</td></tr>';
        }
        libraryHTML += '</tbody></table>';
        libraryDiv.innerHTML = libraryHTML;
    }

    function populateExamManagementPage() { 
        const mainExamsList = document.getElementById('mainExamsList');
        mainExamsList.innerHTML = '<table><thead><tr><th>Name</th><th>Date</th><th>Actions</th></tr></thead><tbody>' + 
            Object.entries(appState.mainExams || {}).map(([id, exam]) => `
                <tr><td>${exam.name}</td><td>${exam.date}</td>
                <td><div class="action-buttons">
                    <button class="action-btn edit-btn" onclick="openEditModal('mainExam', '${id}')" title="Create/Edit Routine"><i class="fas fa-calendar-alt"></i></button>
                    <button class="btn" onclick="generateExamRoutinePdf('${id}')" style="margin:0; padding: 5px 12px; font-size: 0.8rem; background-color: var(--success-color);">Routine PDF</button>
                    <button class="action-btn delete-btn" onclick="deleteItem('${id}', 'mainExams')"><i class="fas fa-trash"></i></button>
                </div></td></tr>
            `).join('') + '</tbody></table>';
        
        const roomsList = document.getElementById('roomsList');
        roomsList.innerHTML = '<table><thead><tr><th>Name/Number</th><th>Capacity</th><th>Action</th></tr></thead><tbody>' +
            Object.entries(appState.rooms || {}).map(([id, room]) => `
                <tr><td>${room.name}</td><td>${room.capacity}</td>
                <td><button class="action-btn delete-btn" onclick="deleteItem('${id}', 'rooms')"><i class="fas fa-trash"></i></button></td></tr>
            `).join('') + '</tbody></table>';
        
        populateDropdownWithKeys(appState.mainExams, 'seatPlanExamSelect', item => item.name);
        populateDropdown(appState.classes, 'seatPlanClassSelect');
        populateDropdownWithKeys(appState.rooms, 'seatPlanRoomSelect', item => `${item.name} (Capacity: ${item.capacity})`, true);
        populateDropdownWithKeys(appState.mainExams, 'rosterExamSelect', item => item.name);
    }

    function populateAdmissionManagementPage() {
        const applications = appState.admissionApplications || {};
        const tbody = document.querySelector('#applicationsTable tbody');
        tbody.innerHTML = '';
        if (Object.keys(applications).length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No pending applications.</td></tr>';
        } else {
            Object.entries(applications).forEach(([id, app]) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${app.studentName}</td>
                        <td>${app.className}</td>
                        <td>${app.guardianContact}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="openEditModal('admissionApplication', '${id}')" title="View/Edit"><i class="fas fa-edit"></i></button>
                                <button class="btn" style="background-color: var(--success-color); padding: 5px 10px; font-size: 0.9rem; width: auto;" onclick="approveApplication('${id}')">Approve</button>
                                <button class="btn" style="background-color: var(--danger-color); padding: 5px 10px; font-size: 0.9rem; width: auto;" onclick="rejectApplication('${id}')">Reject</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }
        
        const admissionClasses = appState.admissionSettings?.formClasses || {};
        populateList(admissionClasses, 'admissionClassList', 'admissionSettings/formClasses');
    }
    
    function approveApplication(applicationId) {
        const application = appState.admissionApplications[applicationId];
        if (!application) {
            alert('Application not found!');
            return;
        }

        const newStudentData = {
            name: application.studentName,
            guardianName: application.guardianName,
            contact: application.guardianContact,
            className: application.className,
            section: 'A', // Default section, can be changed later
            roll: '',     // Roll should be assigned manually
            profilePicUrl: application.profilePicUrl || ''
        };

        if (confirm(`Are you sure you want to approve ${application.studentName} and add them to the student list?`)) {
            db.ref(`schools/${appState.schoolId}/students`).push(newStudentData)
                .then(() => {
                    return db.ref(`schools/${appState.schoolId}/admissionApplications/${applicationId}`).remove();
                })
                .then(() => {
                    alert('Application approved and student has been added successfully!');
                })
                .catch(err => alert('Error: ' + err.message));
        }
    }

    function rejectApplication(applicationId) {
        if (confirm('Are you sure you want to reject and permanently delete this application?')) {
            db.ref(`schools/${appState.schoolId}/admissionApplications/${applicationId}`).remove()
                .then(() => alert('Application rejected and removed.'))
                .catch(err => alert('Error: ' + err.message));
        }
    }


    function openTab(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(tl => tl.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    }
    
    async function generatePdf(elementSelector, fileName, title) {
        const { jsPDF } = window.jspdf;
        const content = document.querySelector(elementSelector);
        if (!content) { console.error("PDF content not found!"); return; }

        const pdfWrapper = document.getElementById('pdf-container');
        pdfWrapper.innerHTML = ''; 

        const header = document.createElement('div');
        header.style.textAlign = 'center'; header.style.marginBottom = '20px'; header.style.borderBottom = '2px solid black'; header.style.paddingBottom = '10px';
        const logoUrl = appState.settings?.schoolLogoUrl;
        const schoolName = document.createElement('h1'); schoolName.textContent = appState.settings?.schoolName || 'School Name';
        const docTitle = document.createElement('h3'); docTitle.textContent = title || fileName.replace(/-/g, ' ');
        
        if(logoUrl) {
            try {
                const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(logoUrl)}`);
                const blob = await response.blob();
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => {
                    const base64data = reader.result;                
                    const img = document.createElement('img');
                    img.src = base64data;
                    img.style.width = '80px'; img.style.height = '80px'; img.style.marginBottom = '10px';
                    header.appendChild(img);
                    header.appendChild(schoolName);
                    header.appendChild(docTitle);
                    createAndDownloadPdf(pdfWrapper, header, content, fileName);
                }
            } catch(e) {
                console.error("CORS issue with logo, proceeding without it.", e);
                header.appendChild(schoolName); header.appendChild(docTitle);
                createAndDownloadPdf(pdfWrapper, header, content, fileName);
            }
        } else {
             header.appendChild(schoolName); header.appendChild(docTitle);
             createAndDownloadPdf(pdfWrapper, header, content, fileName);
        }
    }
    
    async function createAndDownloadPdf(wrapper, header, content, fileName) {
        const { jsPDF } = window.jspdf;
        const mainContent = content.cloneNode(true);
        const footer = document.createElement('div');
        footer.style.textAlign = 'right'; footer.style.marginTop = '50px'; footer.style.paddingTop = '10px';
        const principalName = document.createElement('p');
        principalName.innerHTML = `_______________________<br><strong>${appState.settings?.principalName || 'Principal'}</strong>`;
        principalName.style.margin = '0';
        footer.appendChild(principalName);

        wrapper.appendChild(header);
        wrapper.appendChild(mainContent);
        wrapper.appendChild(footer);
        
        try {
            const canvas = await html2canvas(wrapper, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth() - 80;
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 40, 40, pdfWidth, pdfHeight);
            pdf.save(`${fileName}.pdf`);
        } catch (error) {
            console.error("PDF generation failed:", error);
            alert("Sorry, could not generate the PDF.");
        } finally {
             wrapper.innerHTML = '';
        }
    }

    function generateExamRoutinePdf(examId) {
        const exam = appState.mainExams[examId];
        if (!exam || !exam.routine) { alert('No routine has been created for this exam.'); return; }
        const routineContainer = document.createElement('div');
        routineContainer.id = 'exam-routine-pdf';
        let tableHTML = `<table border="1" style="width:100%; border-collapse: collapse; text-align: center;"><thead><tr><th>Class</th><th>Subject</th><th>Date</th><th>Time</th></tr></thead><tbody>`;
        Object.entries(appState.classes || {}).sort(([,a],[,b])=>a.name.localeCompare(b.name)).forEach(([classKey, classItem]) => {
            const subjectKey = Object.keys(exam.routine).find(k => k.startsWith(classKey) && k.endsWith('_subject'));
            if (subjectKey) {
                 const subject = exam.routine[subjectKey];
                 if (subject) {
                    const date = exam.routine[subjectKey.replace('_subject', '_date')] || '';
                    const time = exam.routine[subjectKey.replace('_subject', '_time')] || '';
                    tableHTML += `<tr><td>${classItem.name}</td><td>${subject}</td><td>${date}</td><td>${time}</td></tr>`;
                }
            }
        });
        tableHTML += '</tbody></table>';
        routineContainer.innerHTML = tableHTML;
        document.body.appendChild(routineContainer);
        generatePdf('#exam-routine-pdf', `Exam-Routine-${exam.name}`, `${exam.name} Routine`);
        document.body.removeChild(routineContainer);
    }

    function generateSeatPlan() {
        const examId = document.getElementById('seatPlanExamSelect').value;
        const classId = document.getElementById('seatPlanClassSelect').value;
        const selectedRoomOptions = document.getElementById('seatPlanRoomSelect').selectedOptions;
        const display = document.getElementById('seatPlanDisplay');
        if(!examId || !classId || selectedRoomOptions.length === 0) {
             display.innerHTML = 'Please select an exam, a class, and at least one room.'; return;
        }

        const students = Object.entries(appState.students || {}).filter(([,s]) => s.className === classId).map(s => s[1]).sort((a,b) => a.roll - b.roll);
        const rooms = Array.from(selectedRoomOptions).map(opt => ({ id: opt.value, ...appState.rooms[opt.value] }));
        
        let html = '';
        let studentIndex = 0;
        rooms.forEach(room => {
            html += `<div class="day-column"><h3>Room: ${room.name} (Capacity: ${room.capacity})</h3><table><thead><tr><th>Roll</th><th>Name</th></tr></thead><tbody>`;
            for(let i=0; i < room.capacity && studentIndex < students.length; i++) {
                const student = students[studentIndex];
                html += `<tr><td>${student.roll}</td><td>${student.name}</td></tr>`;
                studentIndex++;
            }
            html += `</tbody></table></div>`;
        });
        if(studentIndex < students.length) {
            html += `<p style="color: var(--danger-color); margin-top: 20px;"><strong>Warning:</strong> ${students.length - studentIndex} students could not be seated. Please add more rooms.</p>`;
        }
        display.innerHTML = `<div class="schedule-grid">${html}</div>`;
    }

    function renderRosterUI() {
        const examId = document.getElementById('rosterExamSelect').value;
        const date = document.getElementById('rosterDate').value;
        const container = document.getElementById('rosterRoomTeacherSelection');
        const display = document.getElementById('rosterDisplay');
        if (!examId || !date) { container.innerHTML = ''; display.innerHTML = 'Please select an exam and date.'; return; }
        const existingRoster = appState.invigilatorRosters?.[examId]?.[date] || {};
        let html = '';
        Object.entries(appState.rooms || {}).forEach(([roomId, room]) => {
            html += `<div class="input-group"><label>Room: ${room.name}</label><select id="roster_teacher_${roomId}">`;
            html += '<option value="">Select Teacher...</option>';
            Object.entries(appState.teachers || {}).forEach(([teacherId, teacher]) => {
                html += `<option value="${teacherId}" ${existingRoster[roomId] === teacherId ? 'selected' : ''}>${teacher.name}</option>`;
            });
            html += `</select></div>`;
        });
        container.innerHTML = html;
        let displayHtml = `<h3>${appState.mainExams[examId].name} - ${date}</h3><table><thead><tr><th>Room</th><th>Invigilator</th></tr></thead><tbody>`;
        Object.entries(existingRoster).forEach(([roomId, teacherId]) => {
            displayHtml += `<tr><td>${appState.rooms[roomId]?.name}</td><td>${appState.teachers[teacherId]?.name}</td></tr>`;
        });
        displayHtml += '</tbody></table>';
        display.innerHTML = displayHtml;
    }

    function saveInvigilatorRoster() {
        const examId = document.getElementById('rosterExamSelect').value;
        const date = document.getElementById('rosterDate').value;
        if(!examId || !date) { alert('Please select an exam and date.'); return; }
        const updates = {};
        Object.keys(appState.rooms || {}).forEach(roomId => {
            const teacherId = document.getElementById(`roster_teacher_${roomId}`).value;
            if(teacherId) {
                updates[`/schools/${appState.schoolId}/invigilatorRosters/${examId}/${date}/${roomId}`] = teacherId;
            } else {
                 updates[`/schools/${appState.schoolId}/invigilatorRosters/${examId}/${date}/${roomId}`] = null;
            }
        });
        db.ref().update(updates).then(() => {
            alert('Roster saved successfully!');
            renderRosterUI();
        }).catch(err => alert('Error: ' + err.message));
    }

    // --- Library Functions ---
    function populateLibraryManagementPage() {
        populateBooksTable();
        populateIssuedBooksTable();
        populateDropdownWithKeys(appState.library?.books || {}, 'issueBookId', book => `${book.title} by ${book.author} | Available: ${book.availableQuantity}`);
        populateDropdownWithKeys(appState.students || {}, 'issueStudentId', student => `${student.name} (Class: ${student.className})`);
    }
    function populateBooksTable() {
        const container = document.getElementById('allBooksTable');
        let tableHTML = '<table><thead><tr><th>Title</th><th>Author</th><th>ISBN</th><th>Total</th><th>Available</th><th>Action</th></tr></thead><tbody>';
        Object.entries(appState.library?.books || {}).forEach(([id, book]) => {
            tableHTML += `<tr><td>${book.title}</td><td>${book.author}</td><td>${book.isbn || 'N/A'}</td><td>${book.totalQuantity}</td><td>${book.availableQuantity}</td><td><button class="action-btn delete-btn" onclick="deleteItem('${id}', 'library/books')"><i class="fas fa-trash"></i></button></td></tr>`;
        });
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }
    function populateIssuedBooksTable() {
        const container = document.getElementById('issuedBooksTable');
        let tableHTML = '<table><thead><tr><th>Book Title</th><th>Student Name</th><th>Issue Date</th><th>Due Date</th><th>Status</th><th>Action</th></tr></thead><tbody>';
        Object.entries(appState.library?.issuedBooks || {}).sort(([,a], [,b]) => b.issueDate.localeCompare(a.issueDate)).forEach(([id, issue]) => {
            const book = appState.library.books[issue.bookId];
            const student = appState.students[issue.studentId];
            if (book && student) {
                tableHTML += `<tr><td>${book.title}</td><td>${student.name}</td><td>${issue.issueDate}</td><td>${issue.dueDate}</td><td><span style="color: ${issue.status === 'issued' ? 'var(--warning-color)' : 'var(--success-color)'}; font-weight: bold;">${issue.status}</span></td><td>${issue.status === 'issued' ? `<button class="btn" style="padding: 5px 10px; font-size: 0.9rem;" onclick="returnBook('${id}', '${issue.bookId}')">Return</button>` : issue.returnDate}</td></tr>`;
            }
        });
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }
    function returnBook(issueId, bookId) {
        if (!confirm("Are you sure you want to mark this book as returned?")) return;
        const book = appState.library.books[bookId];
        const updates = {};
        updates[`schools/${appState.schoolId}/library/books/${bookId}/availableQuantity`] = (book.availableQuantity || 0) + 1;
        updates[`schools/${appState.schoolId}/library/issuedBooks/${issueId}/status`] = 'returned';
        updates[`schools/${appState.schoolId}/library/issuedBooks/${issueId}/returnDate`] = new Date().toISOString().slice(0, 10);
        db.ref().update(updates).then(() => {
            alert('Book returned successfully!');
        }).catch(err => alert('Error: ' + err.message));
    }

    // --- NEW PDF Generation Functions ---
    function generateAttendanceReportPdf() {
        const classSection = document.getElementById('attendanceClassSelector').value;
        const dateStr = document.getElementById('attendanceDate').value;
        if (!classSection) {
            alert("Please select a class first.");
            return;
        }
        
        const [className, section] = classSection.split('___');
        const date = new Date(dateStr);
        const year = date.getFullYear();
        const month = date.getMonth();
        const monthName = date.toLocaleString('default', { month: 'long' });

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });

        doc.setFontSize(18);
        doc.text(`${appState.settings?.schoolName || 'School Name'}`, doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
        doc.setFontSize(14);
        doc.text(`Attendance Report for ${className} (${section}) - ${monthName} ${year}`, doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });

        const students = Object.entries(appState.students || {}).filter(([,s]) => s.className === className && s.section === section).sort(([,a],[,b]) => a.roll - b.roll);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const attendanceData = appState.attendance || {};

        const head = [['Roll', 'Name']];
        for (let i = 1; i <= daysInMonth; i++) {
            head[0].push(String(i));
        }
        head[0].push('Present');
        head[0].push('Absent');
        head[0].push('%');

        const body = [];
        students.forEach(([studentId, student]) => {
            let presentCount = 0;
            let absentCount = 0;
            const row = [student.roll, student.name];
            for (let i = 1; i <= daysInMonth; i++) {
                const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const status = attendanceData[fullDate]?.[classSection]?.[studentId]?.status;
                if (status === 'present') {
                    row.push('P');
                    presentCount++;
                } else if (status === 'absent') {
                    row.push('A');
                    absentCount++;
                } else {
                    row.push('-');
                }
            }
            const totalDays = presentCount + absentCount;
            const percentage = totalDays > 0 ? ((presentCount / totalDays) * 100).toFixed(1) : 'N/A';
            row.push(presentCount);
            row.push(absentCount);
            row.push(percentage);
            body.push(row);
        });

        doc.autoTable({
            head: head,
            body: body,
            startY: 40,
            theme: 'grid',
            styles: { fontSize: 8, halign: 'center' },
            headStyles: { fillColor: [44, 62, 80] }
        });

        doc.save(`Attendance-${className}-${monthName}.pdf`);
    }

    function generateReportCardPdf(studentId) {
        const student = appState.students[studentId];
        if (!student) { alert("Student not found!"); return; }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(22);
        doc.setFont('helvetica', 'bold');
        doc.text(appState.settings?.schoolName || 'School Name', doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
        doc.setFontSize(16);
        doc.setFont('helvetica', 'normal');
        doc.text('Student Report Card', doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });

        // Student Info
        doc.setFontSize(12);
        doc.text(`Student Name: ${student.name}`, 14, 50);
        doc.text(`Class: ${student.className} (${student.section})`, 14, 57);
        doc.text(`Roll Number: ${student.roll}`, 14, 64);

        // Marks Table
        const head = [['Test Name', 'Subject', 'Marks Obtained', 'Total Marks']];
        const body = [];
        let totalMarksObtained = 0;
        let totalMaxMarks = 0;

        Object.entries(appState.marks || {}).forEach(([examId, examMarks]) => {
            if (examMarks[studentId]) {
                const exam = appState.exams[examId];
                if (exam) {
                    const obtained = parseFloat(examMarks[studentId].marksObtained);
                    const total = parseFloat(exam.totalMarks);
                    body.push([exam.examName, exam.subject, obtained, total]);
                    totalMarksObtained += obtained;
                    totalMaxMarks += total;
                }
            }
        });

        doc.autoTable({ head: head, body: body, startY: 75 });
        
        // Summary
        const finalY = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('Summary:', 14, finalY);
        doc.setFont('helvetica', 'normal');
        doc.text(`Total Marks Obtained: ${totalMarksObtained}`, 14, finalY + 7);
        doc.text(`Total Maximum Marks: ${totalMaxMarks}`, 14, finalY + 14);
        if (totalMaxMarks > 0) {
            const percentage = ((totalMarksObtained / totalMaxMarks) * 100).toFixed(2);
            doc.setFont('helvetica', 'bold');
            doc.text(`Percentage: ${percentage}%`, 14, finalY + 21);
        }
        
        // Footer Signature
        const pageHeight = doc.internal.pageSize.height;
        doc.line(140, pageHeight - 30, 195, pageHeight - 30); // Signature line
        doc.text("Principal's Signature", 142, pageHeight - 22);

        doc.save(`Report-Card-${student.name}.pdf`);
    }

    function generateWordStyleRoutinePdf() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const schoolName = appState.settings?.schoolName || 'School Name';
        const selectedClassText = document.getElementById('routineFilter').selectedOptions[0].text;
        const title = `Class Routine (${selectedClassText})`;

        doc.setFontSize(18);
        doc.text(schoolName, doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
        doc.setFontSize(14);
        doc.text(title, doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });

        const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"];
        const head = [['Time', ...days]];
        
        let schedules = Object.values(appState.schedules || {});
        const filterValue = document.getElementById('routineFilter').value;
        if (filterValue !== 'all') {
            const [className, section] = filterValue.split('___');
            schedules = schedules.filter(s => s.className === className && s.section === section);
        }

        const timeSlots = [...new Set(schedules.map(s => `${s.startTime} - ${s.endTime}`))].sort();
        const body = [];

        timeSlots.forEach(slot => {
            const row = [slot];
            for (let i = 0; i < days.length; i++) {
                const scheduleForSlotAndDay = schedules.find(s => `${s.startTime} - ${s.endTime}` === slot && parseInt(s.day) === i);
                if (scheduleForSlotAndDay) {
                    const teacherName = appState.teachers[scheduleForSlotAndDay.teacherId]?.name || '';
                    row.push(`${scheduleForSlotAndDay.subject}\n${teacherName}`);
                } else {
                    row.push('');
                }
            }
            body.push(row);
        });
        
        doc.autoTable({
            head: head,
            body: body,
            startY: 40,
            theme: 'grid',
            styles: { halign: 'center' },
        });

        doc.save(`Class-Routine-${selectedClassText}.pdf`);
    }


</script>
</html>
